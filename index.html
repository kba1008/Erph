<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eRPH Cloud - Sistem Bintang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .card-week.selected { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
        .star-hover:hover ~ .star-hover { color: #d1d5db; } /* Kelabu jika hover sebelum */
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-indigo-600 mb-2"></div>
            <p class="font-bold text-indigo-900 tracking-wider" id="loadText">SEDANG MEMPROSES...</p>
        </div>
    </div>

    <div id="commentModal" class="fixed inset-0 bg-black bg-opacity-75 hidden justify-center items-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-1 text-gray-800 flex items-center"><span class="material-icons mr-2 text-indigo-500">rate_review</span> Ulasan Pentadbir</h3>
            <p class="text-xs text-gray-500 mb-4" id="commentFileName">-</p>
            <textarea id="adminCommentBox" class="w-full border-2 border-gray-200 rounded-xl p-3 h-32 mb-4 focus:border-indigo-500 outline-none resize-none" placeholder="Masukkan ulasan atau teguran membina di sini..."></textarea>
            <div class="flex justify-end space-x-2">
                <button onclick="closeCommentModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-bold text-sm">Batal</button>
                <button onclick="saveComment()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-lg hover:bg-indigo-700 text-sm">Simpan Ulasan</button>
            </div>
        </div>
    </div>

    <nav class="bg-indigo-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center max-w-2xl">
            <div class="flex items-center space-x-2">
                <span class="material-icons text-yellow-400">stars</span>
                <span class="font-bold uppercase tracking-widest text-lg">eRPH Cloud</span>
            </div>
            <button id="logoutBtn" onclick="logoutUser()" class="hidden bg-red-500 px-4 py-2 rounded-full text-xs font-bold shadow-lg">Log Keluar</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-xl">
        <div id="loginSection" class="bg-white p-8 rounded-3xl shadow-xl mt-8">
            <div class="flex justify-around mb-8 border-b pb-2">
                <button onclick="toggleAuth('login')" id="btnTabLogin" class="font-bold text-indigo-900 border-b-2 border-indigo-900 pb-2">LOG MASUK</button>
                <button onclick="toggleAuth('signup')" id="btnTabSignup" class="font-bold text-gray-400 pb-2">DAFTAR</button>
            </div>
            <div id="divLogin">
                <input type="email" id="loginEmail" placeholder="Emel Google (Gmail)" class="w-full border p-3 rounded-xl mb-4 bg-gray-50">
                <input type="password" id="loginPass" placeholder="Kata Laluan" class="w-full border p-3 rounded-xl mb-6 bg-gray-50">
                <button onclick="doAction('login')" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-700">MASUK SISTEM</button>
                <button onclick="accessMaster()" class="w-full mt-6 text-[10px] text-gray-400 uppercase tracking-widest font-bold">Akses Master Admin</button>
            </div>
            <div id="divSignup" class="hidden space-y-4">
                <input type="text" id="regName" placeholder="Nama Penuh" class="w-full border p-3 rounded-xl bg-gray-50">
                <input type="email" id="regEmail" placeholder="Emel Gmail" class="w-full border p-3 rounded-xl bg-gray-50">
                <input type="password" id="regPass" placeholder="Cipta Kata Laluan" class="w-full border p-3 rounded-xl bg-gray-50">
                <button onclick="doAction('signup')" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-bold">HANTAR PENDAFTARAN</button>
            </div>
        </div>

        <div id="guruPanel" class="tab-content bg-transparent mt-6">
            <div class="bg-gradient-to-r from-indigo-600 to-blue-500 p-6 rounded-3xl shadow-lg text-white mb-6">
                <h2 class="text-2xl font-black uppercase" id="welcomeGuru">Nama</h2>
                <p class="text-xs text-indigo-200 mb-4">Kumpulan: <span id="guruGroup" class="font-bold text-white"></span></p>
                
                <div class="flex justify-between items-center bg-white bg-opacity-20 p-4 rounded-2xl">
                    <div>
                        <p class="text-xs font-bold uppercase tracking-wider text-indigo-100">Bintang Terkumpul</p>
                        <p class="text-3xl font-black flex items-center"><span class="material-icons text-yellow-400 mr-2 text-4xl">star</span> <span id="guruTotalStars">0</span></p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-md mb-6">
                <h3 class="font-bold text-sm text-gray-800 mb-3 flex items-center"><span class="material-icons text-yellow-500 mr-2">emoji_events</span> RANKING MINGGUAN (TOP 3)</h3>
                <div id="top3List" class="space-y-2">
                    <p class="text-xs text-gray-400 italic">Memuatkan kedudukan...</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-md">
                <label class="text-xs font-bold text-gray-400 uppercase">1. Pilih Minggu</label>
                <div id="weekList" class="grid grid-cols-2 gap-2 mb-6 mt-1 p-2 bg-gray-50 rounded-2xl border"></div>
                
                <label class="text-xs font-bold text-gray-400 uppercase">2. Muat Naik Fail RPH</label>
                <input type="file" id="fileInp" class="w-full p-3 border-2 border-dashed border-indigo-200 rounded-2xl mb-4 bg-gray-50 mt-1">
                <input type="hidden" id="selectedWeek">
                <button onclick="uploadRPH()" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-black shadow-lg">HANTAR RPH</button>

                <div id="teacherFilesArea" class="mt-8 pt-6 border-t border-gray-100 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-gray-800 flex items-center"><span class="material-icons text-indigo-500 mr-1">history</span> Status RPH:</h3>
                        <span id="lblTeacherWeek" class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded">-</span>
                    </div>
                    <div id="teacherFileList" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="adminPanel" class="tab-content bg-white p-6 rounded-3xl shadow-xl mt-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="adminGroupName" class="text-xl font-black text-gray-800 uppercase">Nama Sekolah</h2>
                <button onclick="doAction('createWeek')" class="bg-indigo-600 text-white p-2 rounded-xl flex items-center shadow-lg hover:bg-indigo-700"><span class="material-icons text-sm mr-1">add</span> Minggu</button>
            </div>
            
            <label class="text-xs font-bold text-gray-400 uppercase">Senarai Folder Minggu</label>
            <div id="adminWeekList" class="grid grid-cols-2 gap-2 bg-indigo-50 p-4 rounded-2xl mb-6 mt-1"></div>

            <div id="submissionArea" class="hidden mt-6">
                <h3 class="font-bold text-gray-800 border-b pb-2 mb-4 flex justify-between items-center">
                    <span>Semakan RPH Guru</span>
                    <span id="viewingWeek" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded text-xs"></span>
                </h3>
                <div id="adminTeacherGrid" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>

        <div id="masterPanel" class="tab-content bg-gray-900 p-8 rounded-3xl text-white mt-6 shadow-2xl">
            <h2 class="text-2xl font-black text-red-500 mb-6 flex items-center"><span class="material-icons mr-2">admin_panel_settings</span> KAWALAN PUSAT</h2>
            
            <div class="mb-10">
                <h3 class="text-sm font-bold text-gray-400 mb-3 border-b border-gray-700 pb-2">SENARAI KUMPULAN & PRESTASI BINTANG</h3>
                <div id="masterGroupList" class="space-y-4">
                    <p class="text-xs text-gray-500 animate-pulse">Memuatkan data dari pangkalan data...</p>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-inner">
                <h3 id="masterFormTitle" class="text-sm font-bold text-green-400 mb-4 flex items-center"><span class="material-icons text-sm mr-1">add_circle</span> DAFTAR KUMPULAN BAHARU</h3>
                <div class="space-y-4 text-black">
                    <input type="hidden" id="mGMode" value="new">
                    <input type="text" id="mGName" placeholder="Nama Kumpulan (Unik)" class="w-full p-4 rounded-xl mt-1 bg-gray-100 focus:bg-white transition-all text-sm font-bold">
                    <input type="email" id="mGAdmin" placeholder="Emel Admin Kumpulan" class="w-full p-4 rounded-xl mt-1 bg-gray-100 focus:bg-white transition-all text-sm font-bold">
                    <textarea id="mGMembers" placeholder="Senarai Emel Ahli (pisahkan dengan koma)" class="w-full p-4 rounded-xl h-24 mt-1 bg-gray-100 focus:bg-white transition-all text-sm leading-relaxed"></textarea>
                    
                    <div class="flex space-x-2 pt-2">
                        <button id="btnSaveGroup" onclick="submitMasterGroup()" class="flex-1 bg-red-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-red-500 transition-colors">DAFTAR KUMPULAN</button>
                        <button id="btnCancelEdit" onclick="resetMasterForm()" class="hidden bg-gray-500 text-white px-6 py-4 rounded-xl font-bold shadow-lg hover:bg-gray-400 transition-colors">BATAL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ MASUKKAN URL APP SCRIPT CIKGU DI SINI
        const API_URL = "https://script.google.com/macros/s/AKfycbxU93YeTIPrgjlXe9fa7P4UaLi8rpZOddIKYYOPMim3z8Pg6hqi63OfQlsAKyKzADnUmA/exec";
        
        let user = { email: "", group: "", name: "" };
        let currentFileIdForComment = null;

        window.addEventListener('DOMContentLoaded', () => {
            const savedSession = localStorage.getItem('eRPH_UserSession');
            if (savedSession) {
                user = JSON.parse(savedSession);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('logoutBtn').classList.remove('hidden');

                if (user.role === "MASTER") {
                    document.getElementById('masterPanel').classList.add('active-tab'); fetchMasterGroups();
                } else if (user.role === "ADMIN_KUMPULAN") {
                    document.getElementById('adminPanel').classList.add('active-tab');
                    document.getElementById('adminGroupName').innerText = user.group;
                    doAction('getWeeksAdmin');
                } else {
                    document.getElementById('guruPanel').classList.add('active-tab');
                    document.getElementById('welcomeGuru').innerText = user.name;
                    document.getElementById('guruGroup').innerText = user.group;
                    doAction('getWeeksGuru');
                    fetchLeaderboard(); // Muat data Top 3 dan jumlah bintang
                }
            }
        });

        function logoutUser() { localStorage.removeItem('eRPH_UserSession'); location.reload(); }
        function showLoading(s, txt="SEDANG MEMPROSES...") { document.getElementById('loading').style.display = s ? 'flex' : 'none'; document.getElementById('loadText').innerText = txt; }
        function toggleAuth(mode) { document.getElementById('divLogin').classList.toggle('hidden', mode === 'signup'); document.getElementById('divSignup').classList.toggle('hidden', mode === 'login'); }

        async function runAPI(actionName, payloadData) {
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: actionName, data: payloadData }), headers: { "Content-Type": "text/plain;charset=utf-8" }, redirect: 'follow' });
                return await res.json();
            } catch (err) { alert("Ralat Rangkaian. Sila semak internet anda."); return null; }
        }

        async function doAction(action) {
            try {
                if (action === 'login') {
                    // ... [Sama seperti sebelum ini, Login Validation] ...
                    const e = document.getElementById('loginEmail').value; const p = document.getElementById('loginPass').value;
                    if(!e || !p) return alert("Sila isi emel dan kata laluan!");
                    showLoading(true, "MENGESAHKAN AKAUN...");
                    const res = await runAPI('login', { email: e, password: p });
                    showLoading(false);
                    if(!res || res.error) return alert(res ? "Ralat Server: " + res.error : "Ralat");
                    if (!res.found) return alert("GAGAL: " + res.message);
                    
                    user = res; localStorage.setItem('eRPH_UserSession', JSON.stringify(user)); 
                    document.getElementById('loginSection').style.display = 'none'; document.getElementById('logoutBtn').classList.remove('hidden');
                    
                    if(res.role === "ADMIN_KUMPULAN") {
                        document.getElementById('adminPanel').classList.add('active-tab'); document.getElementById('adminGroupName').innerText = res.group; doAction('getWeeksAdmin');
                    } else {
                        document.getElementById('guruPanel').classList.add('active-tab'); document.getElementById('welcomeGuru').innerText = res.name; document.getElementById('guruGroup').innerText = res.group; doAction('getWeeksGuru'); fetchLeaderboard();
                    }
                } 
                else if (action === 'signup') {
                    // ... [Sama seperti sebelum ini] ...
                    const d = { name: document.getElementById('regName').value, email: document.getElementById('regEmail').value, pass: document.getElementById('regPass').value };
                    if(!d.name || !d.email || !d.pass) return alert("Lengkapkan maklumat.");
                    showLoading(true, "MENDAFTAR..."); const res = await runAPI('signup', d); showLoading(false); if(res) { alert(res); toggleAuth('login'); }
                }
                else if (action === 'getWeeksGuru') {
                    const weeks = await runAPI('getWeeks', { group: user.group });
                    if(!weeks) return; const cont = document.getElementById('weekList'); cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-red-500 col-span-2'>Tiada folder.</p>";
                    weeks.forEach(w => {
                        const btn = document.createElement('div'); btn.className = "p-3 border-2 rounded-xl text-center text-sm font-bold cursor-pointer bg-white text-gray-700 card-week hover:border-indigo-300"; btn.innerText = w;
                        btn.onclick = () => { document.getElementById('selectedWeek').value = w; Array.from(cont.children).forEach(c => c.classList.remove('selected')); btn.classList.add('selected'); fetchTeacherFiles(w); };
                        cont.appendChild(btn);
                    });
                }
                else if (action === 'getWeeksAdmin') {
                    const weeks = await runAPI('getWeeks', { group: user.group });
                    if(!weeks) return; const cont = document.getElementById('adminWeekList'); cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-gray-500 col-span-2'>Sila cipta minggu.</p>";
                    weeks.forEach(w => {
                        const btn = document.createElement('div'); btn.className = "p-3 border rounded-xl font-bold text-indigo-900 bg-white shadow-sm text-sm text-center cursor-pointer hover:bg-indigo-100 hover:shadow"; btn.innerText = w;
                        btn.onclick = () => { fetchAdminDashboard(w); }; cont.appendChild(btn);
                    });
                }
                else if (action === 'createWeek') {
                    const n = prompt("Nama Minggu (Cth: MINGGU 1):"); if(!n) return;
                    showLoading(true, "MENCIPTA FOLDER..."); const res = await runAPI('createWeek', { weekName: n, group: user.group }); showLoading(false); 
                    if(res) { alert(res.message); if(res.status === 'success') doAction('getWeeksAdmin'); }
                }
            } catch (error) { showLoading(false); }
        }

        // =====================================
        // FUNGSI GURU: PAPAR RPH & STATISTIK
        // =====================================
        function uploadRPH() {
            const wk = document.getElementById('selectedWeek').value; const f = document.getElementById('fileInp').files[0];
            if(!wk || !f) return alert("Sila pilih MINGGU dan FAIL RPH terlebih dahulu.");
            showLoading(true, "MUAT NAIK FAIL...");
            const reader = new FileReader();
            reader.onload = async function(e) {
                const payload = { data: e.target.result.split(',')[1], mimeType: f.type, fileName: f.name, week: wk, group: user.group, userName: user.name };
                const res = await runAPI('upload', payload); showLoading(false);
                if(res && res.includes("http")) { alert("RPH berjaya dihantar!"); document.getElementById('fileInp').value = ""; fetchTeacherFiles(wk); } else { alert("Gagal memuat naik."); }
            }; reader.readAsDataURL(f);
        }

        async function fetchTeacherFiles(weekName) {
            document.getElementById('teacherFilesArea').classList.remove('hidden'); document.getElementById('lblTeacherWeek').innerText = weekName;
            const cont = document.getElementById('teacherFileList'); cont.innerHTML = "<p class='text-xs text-gray-400 italic animate-pulse'>Menyemak fail anda...</p>";
            const res = await runAPI('getTeacherFiles', { group: user.group, week: weekName, userName: user.name });
            
            if(!res || res.status === "error") return cont.innerHTML = `<p class='text-xs text-red-500'>Tiada folder.</p>`;
            if(res.files.length === 0) return cont.innerHTML = `<p class='text-xs text-gray-500 italic'>Belum ada RPH dihantar.</p>`;

            cont.innerHTML = "";
            res.files.forEach(f => {
                let cleanName = f.name.replace(`[${user.name}] `, '');
                let stars = f.stars ? parseInt(f.stars) : 0;
                let isReviewed = stars > 0 || f.comment;
                
                let starDisplay = "";
                for(let i=1; i<=5; i++) { starDisplay += `<span class="material-icons text-sm ${i <= stars ? 'text-yellow-400' : 'text-gray-300'}">star</span>`; }

                let commentHTML = f.comment ? `<div class="mt-2 bg-indigo-50 p-2 rounded text-xs border border-indigo-100"><span class="font-bold text-indigo-800">Ulasan:</span> <span class="text-gray-700 italic">"${f.comment}"</span></div>` : '';
                let statusBadge = isReviewed ? `<span class="bg-green-500 text-white text-[9px] px-2 py-0.5 rounded shadow-sm">TELAH DISEMAK</span>` : `<span class="bg-yellow-400 text-yellow-900 text-[9px] px-2 py-0.5 rounded shadow-sm">MENUNGGU SEMAKAN</span>`;

                cont.innerHTML += `
                <div class="p-3 rounded-xl border ${isReviewed ? 'bg-white border-green-200' : 'bg-gray-50 border-gray-200'} shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 pr-2">
                            <p class="text-xs font-bold text-gray-700 truncate">${cleanName}</p>
                            <div class="mt-1">${statusBadge}</div>
                        </div>
                        <button onclick="window.open('${f.url}', '_blank')" class="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-indigo-200 flex items-center"><span class="material-icons text-xs mr-1">visibility</span> BUKA</button>
                    </div>
                    ${isReviewed ? `<div class="pt-2 border-t border-gray-100 flex items-center">${starDisplay}</div>${commentHTML}` : ''}
                </div>`;
            });
        }

        async function fetchLeaderboard() {
            // Memanggil API untuk dapatkan total bintang dan Top 3
            const res = await runAPI('getLeaderboard', { group: user.group, userName: user.name });
            if(res && res.status === "success") {
                document.getElementById('guruTotalStars').innerText = res.myTotalStars || "0";
                
                const cont = document.getElementById('top3List');
                if(res.top3 && res.top3.length > 0) {
                    cont.innerHTML = "";
                    let colors = ['text-yellow-500', 'text-gray-400', 'text-amber-700']; // Gold, Silver, Bronze
                    res.top3.forEach((t, index) => {
                        let rankIcon = index < 3 ? `<span class="material-icons ${colors[index]} text-lg mr-2">military_tech</span>` : `<span class="text-xs text-gray-400 w-6 text-center inline-block mr-2">${index+1}.</span>`;
                        cont.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg border border-gray-100">
                            <div class="flex items-center"><span class="font-bold text-sm ${index===0?'text-gray-800':'text-gray-600'} flex items-center">${rankIcon} ${t.name}</span></div>
                            <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full flex items-center"><span class="material-icons text-[10px] mr-1">star</span> ${t.stars}</span>
                        </div>`;
                    });
                } else { cont.innerHTML = "<p class='text-xs text-gray-500 italic'>Belum ada rekod penilaian.</p>"; }
            }
        }

        // =====================================
        // FUNGSI PENTADBIR: RATE & KOMEN
        // =====================================
        async function fetchAdminDashboard(weekName) {
            document.getElementById('submissionArea').classList.remove('hidden'); document.getElementById('viewingWeek').innerText = weekName;
            const cont = document.getElementById('adminTeacherGrid'); cont.innerHTML = "<p class='text-xs text-center text-gray-500 animate-pulse'>Menyusun fail guru...</p>";

            const res = await runAPI('getAdminSubmissionsData', { group: user.group, week: weekName });
            if(!res || res.status === "error") return cont.innerHTML = `<p class='text-red-500 text-xs'>${res?res.message:'Ralat sistem'}</p>`;
            if(res.data.length === 0) return cont.innerHTML = "<p class='text-xs text-gray-500'>Tiada cikgu berdaftar.</p>";

            cont.innerHTML = "";
            res.data.forEach(teacher => {
                let cardHtml = `
                <div class="bg-white border border-indigo-100 p-4 rounded-2xl flex flex-col shadow-sm">
                    <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                        <div class="flex items-center space-x-2">
                            <span class="material-icons text-indigo-400 text-2xl">folder_shared</span>
                            <div>
                                <h4 class="font-bold text-sm text-indigo-900">${teacher.teacherName}</h4>
                                <p class="text-[10px] text-gray-400 font-bold flex items-center"><span class="material-icons text-[10px] text-yellow-500 mr-0.5">star</span> Total Keseluruhan: ${teacher.totalStars || 0}</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">`;

                if(teacher.files.length === 0) { cardHtml += `<div class="py-2 text-center text-gray-400 text-xs italic">Belum hantar RPH minggu ini.</div>`; } 
                else {
                    teacher.files.forEach(f => {
                        let cleanName = f.name.replace(`[${teacher.teacherName}] `, '');
                        let currentStars = f.stars ? parseInt(f.stars) : 0;
                        let hasComment = f.comment ? true : false;
                        
                        // Bina elemen Bintang boleh klik
                        let starWidget = `<div class="flex space-x-1" id="star-widget-${f.id}">`;
                        for(let i=1; i<=5; i++) {
                            let color = i <= currentStars ? "text-yellow-400" : "text-gray-200 hover:text-yellow-300 transition-colors";
                            starWidget += `<span onclick="submitRating('${f.id}', ${i})" class="material-icons cursor-pointer text-xl ${color} select-none">star</span>`;
                        }
                        starWidget += `</div>`;

                        let commentBtnClass = hasComment ? "bg-indigo-100 text-indigo-600 border-indigo-300" : "bg-gray-50 text-gray-400 border-gray-200 hover:bg-gray-100";

                        cardHtml += `
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-700 font-bold truncate pr-2 w-2/3" title="${cleanName}">ðŸ“„ ${cleanName}</span>
                                <button onclick="window.open('${f.url}', '_blank')" class="text-[9px] bg-white border border-gray-300 text-gray-600 px-2 py-1 rounded shadow-sm hover:bg-gray-50 font-bold flex items-center"><span class="material-icons text-[10px] mr-1">open_in_new</span> BUKA</button>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                                ${starWidget}
                                <button onclick="openCommentModal('${f.id}', '${f.comment || ''}', '${cleanName}')" class="${commentBtnClass} border px-2 py-1 rounded flex items-center text-[10px] font-bold transition-colors" title="Beri Ulasan"><span class="material-icons text-sm mr-1">rate_review</span> ULASAN</button>
                            </div>
                        </div>`;
                    });
                }
                cardHtml += `</div></div>`;
                cont.innerHTML += cardHtml;
            });
        }

        async function submitRating(fileId, stars) {
            showLoading(true, "MENYIMPAN BINTANG...");
            const res = await runAPI('rateRPH', { fileId: fileId, stars: stars, comment: null }); // Set rate sahaja
            showLoading(false);
            if(res && res.status === "success") { fetchAdminDashboard(document.getElementById('viewingWeek').innerText); } 
            else alert("Gagal menyimpan markah bintang.");
        }

        function openCommentModal(fileId, currentComment, fileName) {
            currentFileIdForComment = fileId;
            document.getElementById('commentFileName').innerText = "Fail: " + fileName;
            document.getElementById('adminCommentBox').value = currentComment && currentComment !== 'undefined' ? currentComment : "";
            document.getElementById('commentModal').classList.remove('hidden'); document.getElementById('commentModal').classList.add('flex');
        }

        function closeCommentModal() { document.getElementById('commentModal').classList.add('hidden'); document.getElementById('commentModal').classList.remove('flex'); currentFileIdForComment = null; }

        async function saveComment() {
            const txt = document.getElementById('adminCommentBox').value.trim();
            if(!currentFileIdForComment) return;
            showLoading(true, "MENYIMPAN ULASAN...");
            // Menghantar ulasan sahaja (markah bintang sedia ada tidak disentuh, akan dikawal di backend)
            const res = await runAPI('rateRPH', { fileId: currentFileIdForComment, stars: null, comment: txt });
            showLoading(false);
            if(res && res.status === "success") { closeCommentModal(); fetchAdminDashboard(document.getElementById('viewingWeek').innerText); } 
            else alert("Gagal menyimpan ulasan.");
        }


        // =====================================
        // FUNGSI MASTER ADMIN
        // =====================================
        function accessMaster() { 
            if(prompt("Kod Master (101010):") === "101010") { 
                user = { role: "MASTER", name: "MASTER ADMIN" }; localStorage.setItem('eRPH_UserSession', JSON.stringify(user));
                document.getElementById('loginSection').style.display = 'none'; document.getElementById('masterPanel').classList.add('active-tab'); document.getElementById('logoutBtn').classList.remove('hidden'); fetchMasterGroups();
            } 
        }

        async function fetchMasterGroups() {
            const cont = document.getElementById('masterGroupList'); cont.innerHTML = "<p class='text-xs text-gray-500 animate-pulse'>Menarik rekod pelayan...</p>";
            const res = await runAPI('getAllGroups', {}); // Andaikan API ini kini memulangkan maklumat rating total guru (teacherStats)
            if (!res || res.status === "error") return cont.innerHTML = `<p class='text-xs text-red-500'>Ralat muat turun data.</p>`;
            
            cont.innerHTML = "";
            res.data.forEach(g => {
                let memberCount = g.members ? g.members.split(',').filter(m=>m.trim()!=='').length : 0;
                
                // Senarai prestasi guru untuk dipapar oleh Master
                let teacherStatsHTML = "";
                if(g.teacherStats && g.teacherStats.length > 0) {
                    teacherStatsHTML = `<div class="mt-3 bg-gray-900 rounded-lg p-2 border border-gray-700 max-h-32 overflow-y-auto space-y-1">`;
                    g.teacherStats.forEach(ts => {
                        teacherStatsHTML += `<div class="flex justify-between items-center text-[10px]"><span class="text-gray-300">${ts.name}</span><span class="text-yellow-400 font-bold flex items-center"><span class="material-icons text-[10px] mr-1">star</span> ${ts.totalStars}</span></div>`;
                    });
                    teacherStatsHTML += `</div>`;
                }

                cont.innerHTML += `
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-600 shadow-md">
                    <div class="flex justify-between items-start">
                        <div class="overflow-hidden pr-2 flex-1">
                            <h4 class="font-bold text-white text-sm truncate uppercase">${g.groupName}</h4>
                            <p class="text-[10px] text-gray-300 mt-1 truncate"><span class="text-green-400 font-bold">A:</span> ${g.adminEmail}</p>
                            <p class="text-[10px] text-gray-400"><span class="text-blue-400 font-bold">G:</span> ${memberCount} ahli didaftarkan</p>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="editMasterGroup('${g.groupName}', '${g.adminEmail}', '${g.members}')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-blue-500 shadow flex items-center justify-center"><span class="material-icons text-[12px] mr-1">edit</span></button>
                            <button onclick="deleteMasterGroup('${g.groupName}')" class="bg-red-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-red-700 shadow flex items-center justify-center"><span class="material-icons text-[12px] mr-1">delete</span></button>
                        </div>
                    </div>
                    ${teacherStatsHTML}
                </div>`;
            });
        }

        function editMasterGroup(gName, gAdmin, gMembers) { document.getElementById('mGMode').value = "edit"; document.getElementById('mGName').value = gName; document.getElementById('mGName').readOnly = true; document.getElementById('mGName').classList.add('opacity-50', 'cursor-not-allowed'); document.getElementById('mGAdmin').value = gAdmin; document.getElementById('mGMembers').value = gMembers; document.getElementById('btnSaveGroup').innerText = "SIMPAN PERUBAHAN"; document.getElementById('btnCancelEdit').classList.remove('hidden'); window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
        function resetMasterForm() { document.getElementById('mGMode').value = "new"; document.getElementById('mGName').value = ""; document.getElementById('mGName').readOnly = false; document.getElementById('mGName').classList.remove('opacity-50', 'cursor-not-allowed'); document.getElementById('mGAdmin').value = ""; document.getElementById('mGMembers').value = ""; document.getElementById('btnSaveGroup').innerText = "DAFTAR KUMPULAN"; document.getElementById('btnCancelEdit').classList.add('hidden'); }
        async function submitMasterGroup() { const mode = document.getElementById('mGMode').value; const name = document.getElementById('mGName').value.trim(); const admin = document.getElementById('mGAdmin').value.trim(); const members = document.getElementById('mGMembers').value.trim(); if (!name || !admin) return alert("Isi maklumat asas."); showLoading(true, "MENYIMPAN..."); const res = await runAPI(mode === 'new' ? 'saveGroup' : 'updateGroup', { groupName: name, adminEmail: admin, memberEmailsStr: members }); showLoading(false); if (res) { alert(res.message || res); resetMasterForm(); fetchMasterGroups(); } }
        async function deleteMasterGroup(gName) { if (confirm(`Pasti padam kumpulan '${gName}'?`)) { showLoading(true, "MEMADAM..."); const res = await runAPI('deleteGroup', { groupName: gName }); showLoading(false); if (res) { alert(res.message); resetMasterForm(); fetchMasterGroups(); } } }
    </script>
</body>
</html>
