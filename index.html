<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eRPH Cloud 551</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 9999; color: white; }
        .tab-content { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab { display: block; }
        .card-week.selected { border-color: #6366f1 !important; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important; color: #312e81 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .star-icon { cursor: pointer; transition: transform 0.2s, color 0.2s; }
        .star-icon:hover { color: #fbbf24; transform: scale(1.2); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .glass-nav { background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-[conic-gradient(at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-purple-900 to-slate-900 min-h-screen font-sans selection:bg-pink-500 selection:text-white">

    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-pink-500 mb-4"></div>
            <p class="font-black text-xl text-white tracking-[0.2em] animate-pulse" id="loadText">SEDANG MEMPROSES...</p>
        </div>
    </div>

    <nav class="glass-nav text-white p-4 sticky top-0 z-50 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center max-w-2xl">
            <div class="flex items-center space-x-2">
                <div class="bg-gradient-to-br from-pink-500 to-orange-400 p-2 rounded-lg shadow-lg">
                    <span class="material-icons text-white">cloud_done</span>
                </div>
                <span class="font-black uppercase tracking-widest text-lg text-transparent bg-clip-text bg-gradient-to-r from-pink-200 to-indigo-200 drop-shadow-sm">eRPH Cloud</span>
            </div>
            <div class="flex space-x-2">
                <button id="groupBtn" onclick="showGroupSelection()" class="hidden bg-indigo-600/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-indigo-500 hover:scale-105 transition-transform">Kumpulan</button>
                <button id="switchRoleBtn" onclick="switchRoleView()" class="hidden bg-green-500/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-green-600 hover:scale-105 transition-transform">Mod Guru</button>
                <button id="changePassBtn" onclick="changeOwnPassword()" class="hidden bg-yellow-500/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-yellow-400 hover:scale-105 transition-transform">Pass</button>
                <button id="logoutBtn" onclick="doLogout()" class="hidden bg-red-500/80 px-4 py-2 rounded-full text-xs font-bold shadow-lg hover:bg-red-600 hover:scale-105 transition-transform">Keluar</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-xl pb-20">
        <div id="loginSection" class="glass-panel p-8 rounded-3xl shadow-2xl mt-8 transform transition-all hover:shadow-[0_20px_50px_rgba(8,_112,_184,_0.7)]">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-black text-slate-800 mb-1">SELAMAT DATANG</h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Portal Pengurusan RPH Digital</p>
            </div>
            <div class="flex justify-around mb-8 border-b pb-2">
                <button onclick="toggleAuth('login')" id="btnTabLogin" class="font-bold text-indigo-900 border-b-4 border-indigo-600 pb-2 transition-all">LOG MASUK</button>
                <button onclick="toggleAuth('signup')" id="btnTabSignup" class="font-bold text-gray-400 pb-2 hover:text-indigo-500 transition-all">DAFTAR</button>
            </div>
            <div id="divLogin">
                <input type="text" id="loginIC" placeholder="No. Kad Pengenalan" class="w-full border-2 border-gray-100 p-4 rounded-xl mb-4 bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition-all shadow-inner font-bold text-gray-700">
                <input type="password" id="loginPass" placeholder="Kata Laluan" class="w-full border-2 border-gray-100 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition-all shadow-inner font-bold text-gray-700">
                
                <!-- LOCK ICON TOGGLE -->
                <div class="flex items-center mb-6 justify-end cursor-pointer transition-colors select-none" onclick="toggleRemember()">
                    <div id="lockContainer" class="flex items-center text-gray-400 hover:text-indigo-600 bg-gray-100 px-3 py-1 rounded-full">
                         <span id="lockIcon" class="material-icons text-sm mr-1">lock_open</span>
                         <span id="lockText" class="text-[10px] font-bold uppercase tracking-wider">Ingat Saya</span>
                    </div>
                    <input type="checkbox" id="chkRemember" class="hidden">
                </div>

                <button onclick="doAction('login')" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black shadow-lg hover:shadow-indigo-500/50 hover:scale-[1.02] transition-all tracking-wider text-sm">MASUK SISTEM</button>
                <button onclick="accessMaster()" class="w-full mt-6 text-[10px] text-gray-400 uppercase tracking-widest font-bold hover:text-indigo-500">Akses Master Admin</button>
            </div>
            <div id="divSignup" class="hidden space-y-4">
                <input type="text" id="regName" placeholder="Nama Penuh" class="w-full border-2 border-gray-100 p-4 rounded-xl bg-gray-50 focus:border-indigo-500 outline-none font-bold">
                <input type="text" id="regIC" placeholder="No. Kad Pengenalan (Tanpa -)" class="w-full border-2 border-gray-100 p-4 rounded-xl bg-gray-50 focus:border-indigo-500 outline-none font-bold">
                <input type="password" id="regPass" placeholder="Cipta Kata Laluan" class="w-full border-2 border-gray-100 p-4 rounded-xl bg-gray-50 focus:border-indigo-500 outline-none font-bold">
                <button onclick="doAction('signup')" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold hover:bg-slate-900 transition-all shadow-lg">HANTAR PENDAFTARAN</button>
            </div>
        </div>

        <!-- NEW: GROUP SELECTION PANEL -->
        <div id="groupSelectionPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <h2 class="text-xl font-black text-indigo-900 mb-4 uppercase text-center tracking-wide">Pilih Kumpulan Anda</h2>
            <div id="groupListContainer" class="space-y-3">
                <!-- Buttons injected here -->
            </div>
        </div>

        <div id="guruPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight" id="welcomeGuru">Nama</h2>
                    <p class="text-sm text-slate-500 mb-6 font-medium">Kumpulan: <span id="guruGroup" class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"></span></p>
                </div>
                <div id="myStats" class="bg-gradient-to-br from-yellow-100 to-orange-100 p-3 rounded-2xl text-center border border-yellow-200 shadow-sm">
                    <p class="text-[9px] font-black text-yellow-800 uppercase tracking-wide">Markah Terkumpul</p>
                    <div class="flex items-center justify-center space-x-1 mt-1">
                        <span class="material-icons text-yellow-600 text-sm">star</span>
                        <span id="myWeeklyStars" class="font-black text-2xl text-yellow-900">0</span>
                    </div>
                </div>
            </div>
            
            <div id="leaderboardArea" class="mb-6 bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-2xl border border-indigo-100 hidden">
                <h3 class="text-xs font-bold text-indigo-900 uppercase mb-2 flex items-center"><span class="material-icons text-sm mr-1">emoji_events</span> TOP 3 TERKUMPUL</h3>
                <div id="leaderboardList" class="space-y-2"></div>
            </div>

            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">1. Pilih Minggu</label>
            <div id="weekList" class="grid grid-cols-2 gap-3 mb-6 mt-2 p-3 bg-slate-50/50 rounded-2xl border border-slate-200"></div>
            
            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">2. Muat Naik Fail RPH</label>
            <div class="relative mt-2 mb-4">
                <input type="file" id="fileInp" class="w-full p-4 border-2 border-dashed border-indigo-300 rounded-2xl bg-indigo-50/30 text-sm font-bold text-indigo-900 focus:bg-white transition-all">
                <div class="absolute top-0 right-0 p-4 pointer-events-none">
                    <span class="material-icons text-indigo-300">cloud_upload</span>
                </div>
            </div>
            <input type="hidden" id="selectedWeek">
            <button onclick="uploadRPH()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black shadow-lg hover:shadow-indigo-500/50 hover:scale-[1.02] transition-all">HANTAR RPH</button>

            <div id="teacherFilesArea" class="mt-8 pt-6 border-t border-slate-200 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-800 flex items-center uppercase tracking-wide"><span class="material-icons text-indigo-500 mr-1">history</span> Sejarah Hantaran:</h3>
                    <span id="lblTeacherWeek" class="bg-indigo-100 text-indigo-800 text-xs font-black px-3 py-1 rounded-full">-</span>
                </div>
                <div id="teacherFileList" class="space-y-3"></div>
            </div>
        </div>

        <div id="adminPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="adminGroupName" class="text-xl font-black text-slate-800 uppercase">Nama Sekolah</h2>
                <button onclick="doAction('createWeek')" class="bg-indigo-600 text-white p-2 px-4 rounded-xl flex items-center shadow-lg hover:bg-indigo-500 font-bold text-xs"><span class="material-icons text-sm mr-1">add</span> Minggu</button>
            </div>
            
            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Senarai Folder Minggu</label>
            <div id="adminWeekList" class="grid grid-cols-2 gap-3 bg-slate-50/50 p-4 rounded-2xl mb-6 mt-2 border border-slate-200"></div>

            <div id="submissionArea" class="hidden mt-6">
                <h3 class="font-bold text-slate-800 border-b pb-2 mb-4 flex justify-between items-center">
                    <span class="uppercase tracking-wide text-sm">Folder Guru</span>
                    <span id="viewingWeek" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-[10px] font-black"></span>
                </h3>
                <div id="adminTeacherGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div id="masterPanel" class="tab-content bg-slate-900/95 backdrop-blur p-8 rounded-3xl text-white mt-6 shadow-2xl border border-slate-700">
            <h2 class="text-2xl font-black text-red-500 mb-6 flex items-center tracking-tighter"><span class="material-icons mr-2">admin_panel_settings</span> KAWALAN PUSAT</h2>
            
            <!-- SENARAI USER -->
            <div class="mb-10 bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-inner">
                <h3 class="text-xs font-black text-blue-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Senarai Pengguna (IC)</h3>
                <div id="masterUserList" class="space-y-2 h-64 overflow-auto custom-scrollbar">
                    <p class="text-xs text-slate-500 animate-pulse">Memuatkan data pengguna...</p>
                </div>
            </div>

            <div class="mb-10">
                <h3 class="text-xs font-black text-slate-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Kumpulan Berdaftar</h3>
                <div id="masterGroupList" class="space-y-3">
                    <p class="text-xs text-slate-500 animate-pulse">Memuatkan data dari pangkalan data...</p>
                </div>
            </div>
            
            <div class="mb-10">
                 <h3 class="text-xs font-black text-yellow-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Global Leaderboard</h3>
                 <div id="masterStatsList" class="space-y-2 bg-slate-800 p-4 rounded-xl h-48 overflow-auto border border-slate-700">
                     <p class="text-xs text-slate-500 italic">Sila tunggu...</p>
                 </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-inner">
                <h3 id="masterFormTitle" class="text-sm font-bold text-green-400 mb-4 flex items-center uppercase tracking-wide"><span class="material-icons text-sm mr-1">add_circle</span> Daftar Kumpulan Baharu</h3>
                <div class="space-y-4 text-black">
                    <input type="hidden" id="mGMode" value="new">
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Nama Kumpulan (Unik)</label>
                        <input type="text" id="mGName" placeholder="Contoh: SK BANDAR BARU" class="w-full p-4 rounded-xl mt-1 bg-slate-100 focus:bg-white transition-all font-bold">
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">IC Admin Kumpulan</label>
                        <input type="text" id="mGAdmin" placeholder="No. IC Admin" class="w-full p-4 rounded-xl mt-1 bg-slate-100 focus:bg-white transition-all font-bold">
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Senarai IC Ahli (Guru)</label>
                        <textarea id="mGMembers" placeholder="pisahkan, dengan, koma" class="w-full p-4 rounded-xl h-24 mt-1 bg-slate-100 focus:bg-white transition-all leading-relaxed font-mono text-xs"></textarea>
                    </div>

                    <div class="flex space-x-2 pt-2">
                        <button id="btnSaveGroup" onclick="submitMasterGroup()" class="flex-1 bg-red-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-red-500 transition-colors">DAFTAR KUMPULAN</button>
                        <button id="btnCancelEdit" onclick="resetMasterForm()" class="hidden bg-slate-500 text-white px-6 py-4 rounded-xl font-bold shadow-lg hover:bg-slate-400 transition-colors">BATAL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzD5YBU-G1dPD_SfjO5sPSK2Rj8XLFcrzXhbqsB7nepqHmdWbOkNuxsCymeQgHh0yEB/exec";
        
        let user = { email: "", groups: [], activeGroup: "", activeRole: "", name: "" };

        // --- SESSION RESTORE LOGIC ---
        try {
            // RESTORE LOCK STATE PERSISTENCE (Added for Tighter Security)
            if(localStorage.getItem('erph_lock_ui') === 'true') {
                document.addEventListener("DOMContentLoaded", () => {
                    const chk = document.getElementById('chkRemember');
                    const icon = document.getElementById('lockIcon');
                    const cnt = document.getElementById('lockContainer');
                    if(chk) {
                        chk.checked = true;
                        icon.innerText = "lock";
                        cnt.classList.remove('text-gray-400');
                        cnt.classList.add('text-indigo-600');
                    }
                });
            }

            const savedSess = localStorage.getItem('erph_session');
            if(savedSess) {
                const s = JSON.parse(savedSess);
                if(s && s.ic) {
                    user = s;
                    // Force lock state true if logged in (Syncs state)
                    localStorage.setItem('erph_lock_ui', 'true');
                    
                    // UI Restore
                    document.addEventListener("DOMContentLoaded", () => {
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('logoutBtn').classList.remove('hidden');
                        document.getElementById('changePassBtn').classList.remove('hidden');
                        showGroupSelection();
                    });
                }
            }
        } catch(e) { console.log("No session"); }

        function showLoading(s, txt="SEDANG MEMPROSES...") { 
            document.getElementById('loading').style.display = s ? 'flex' : 'none'; 
            document.getElementById('loadText').innerText = txt;
        }
        
        function toggleRemember() {
            const chk = document.getElementById('chkRemember');
            const icon = document.getElementById('lockIcon');
            const cnt = document.getElementById('lockContainer');
            
            chk.checked = !chk.checked;
            
            if(chk.checked) {
                icon.innerText = "lock";
                cnt.classList.remove('text-gray-400');
                cnt.classList.add('text-indigo-600');
                localStorage.setItem('erph_lock_ui', 'true'); // Save Persistent Lock State
            } else {
                icon.innerText = "lock_open";
                cnt.classList.add('text-gray-400');
                cnt.classList.remove('text-indigo-600');
                localStorage.setItem('erph_lock_ui', 'false'); // Save Persistent Unlock State
            }
        }

        function doLogout() {
            localStorage.removeItem('erph_session');
            location.reload();
        }

        function toggleAuth(mode) {
            document.getElementById('divLogin').classList.toggle('hidden', mode === 'signup');
            document.getElementById('divSignup').classList.toggle('hidden', mode === 'login');
            document.getElementById('btnTabLogin').className = mode === 'login' ? "font-bold text-indigo-900 border-b-4 border-indigo-600 pb-2 transition-all" : "font-bold text-gray-400 pb-2 hover:text-indigo-500 transition-all";
            document.getElementById('btnTabSignup').className = mode === 'signup' ? "font-bold text-indigo-900 border-b-4 border-indigo-600 pb-2 transition-all" : "font-bold text-gray-400 pb-2 hover:text-indigo-500 transition-all";
        }

        async function runAPI(actionName, payloadData) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: actionName, data: payloadData }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    redirect: 'follow'
                });
                return await res.json();
            } catch (err) { Swal.fire(
