<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eRPH Cloud 551</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .card-week.selected { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-4 border-indigo-600 mb-2"></div>
            <p class="font-bold text-indigo-900">Sila Tunggu...</p>
        </div>
    </div>

    <nav class="bg-indigo-900 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <span class="font-bold uppercase tracking-widest">eRPH Cloud 551</span>
            <button id="logoutBtn" onclick="location.reload()" class="hidden bg-red-500 px-3 py-1 rounded text-xs uppercase font-bold">Keluar</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-lg">
        <div id="loginSection" class="bg-white p-8 rounded-2xl shadow-lg mt-10">
            <div class="flex justify-around mb-6 border-b pb-2">
                <button onclick="toggleAuth('login')" id="btnTabLogin" class="font-bold text-indigo-900 border-b-2 border-indigo-900">MASUK</button>
                <button onclick="toggleAuth('signup')" id="btnTabSignup" class="font-bold text-gray-400">DAFTAR</button>
            </div>
            
            <div id="divLogin">
                <input type="email" id="loginEmail" placeholder="Emel Gmail" class="w-full border p-3 rounded-xl mb-3 outline-none">
                <input type="password" id="loginPass" placeholder="Kata Laluan" class="w-full border p-3 rounded-xl mb-6 outline-none">
                <button onclick="doLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">LOG MASUK</button>
                <button onclick="accessMaster()" class="w-full mt-10 text-[10px] text-gray-300">MASTER ADMIN</button>
            </div>

            <div id="divSignup" class="hidden space-y-4">
                <input type="text" id="regName" placeholder="Nama Penuh" class="w-full border p-3 rounded-xl outline-none">
                <input type="email" id="regEmail" placeholder="Emel Gmail" class="w-full border p-3 rounded-xl outline-none">
                <input type="password" id="regPass" placeholder="Kata Laluan" class="w-full border p-3 rounded-xl outline-none">
                <button onclick="doSignup()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold">DAFTAR SEKARANG</button>
            </div>
        </div>

        <div id="guruPanel" class="tab-content bg-white p-6 rounded-2xl shadow-lg mt-6">
            <h2 class="text-xl font-bold text-indigo-900 mb-1" id="welcomeGuru">Selamat Datang</h2>
            <p class="text-xs text-gray-500 mb-6">Kumpulan: <span id="guruGroup" class="font-bold text-indigo-600"></span></p>

            <label class="text-xs font-bold text-gray-400 uppercase">Langkah 1: Pilih Minggu</label>
            <div id="weekList" class="grid grid-cols-2 gap-2 mt-2 mb-6"></div>
            
            <label class="text-xs font-bold text-gray-400 uppercase">Langkah 2: Pilih Fail (PDF)</label>
            <input type="file" id="fileInp" class="w-full border p-3 rounded-xl mt-2 mb-6 text-sm">
            
            <input type="hidden" id="selectedWeek">
            <button onclick="uploadRPH()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold">HANTAR RPH</button>
        </div>

        <div id="adminPanel" class="tab-content bg-white p-6 rounded-2xl shadow-lg mt-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="adminGroupName" class="text-xl font-bold text-gray-800">Admin Kumpulan</h2>
                <button onclick="addWeek()" class="bg-indigo-600 text-white p-2 rounded-lg"><span class="material-icons">add</span></button>
            </div>
            <div id="adminWeekList" class="space-y-2"></div>
        </div>

        <div id="masterPanel" class="tab-content bg-black p-6 rounded-2xl text-white mt-6">
            <h2 class="text-red-500 font-bold mb-4">DAFTAR KUMPULAN</h2>
            <div class="space-y-3 text-black">
                <input type="text" id="mGName" placeholder="Nama Kumpulan/Sekolah" class="w-full p-3 rounded-lg">
                <input type="text" id="mGAdmin" placeholder="Emel Admin Kumpulan" class="w-full p-3 rounded-lg">
                <textarea id="mGMembers" placeholder="Emel Ahli (koma)" class="w-full p-3 rounded-lg"></textarea>
                <button onclick="doSaveGroup()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold">SIMPAN KUMPULAN</button>
            </div>
        </div>
    </div>

    <script>
        let user = { email: "", group: "", name: "" };

        function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
        
        function toggleAuth(mode) {
            document.getElementById('divLogin').classList.toggle('hidden', mode === 'signup');
            document.getElementById('divSignup').classList.toggle('hidden', mode === 'login');
        }

        function doLogin() {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            if(!e || !p) return alert("Isi semua ruangan!");
            showLoading(true);
            
            google.script.run.withSuccessHandler(res => {
                showLoading(false);
                if(!res.found) return alert("Gagal Log Masuk!");
                user = res;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('logoutBtn').classList.remove('hidden');
                
                if(res.role === "ADMIN_KUMPULAN") {
                    document.getElementById('adminPanel').classList.add('active-tab');
                    document.getElementById('adminGroupName').innerText = res.group;
                    loadWeeksAdmin();
                } else {
                    document.getElementById('guruPanel').classList.add('active-tab');
                    document.getElementById('welcomeGuru').innerText = "Hi, " + res.name;
                    document.getElementById('guruGroup').innerText = res.group;
                    loadWeeksGuru();
                }
            }).verifyUserLogin(e, p);
        }

        function doSignup() {
            const d = { name: document.getElementById('regName').value, email: document.getElementById('regEmail').value, pass: document.getElementById('regPass').value };
            showLoading(true);
            google.script.run.withSuccessHandler(res => {
                showLoading(false);
                alert(res);
                toggleAuth('login');
            }).registerUserToDrive(d);
        }

        function loadWeeksGuru() {
            google.script.run.withSuccessHandler(weeks => {
                const cont = document.getElementById('weekList');
                cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-red-500 col-span-2'>Tiada minggu dibuka.</p>";
                weeks.forEach(w => {
                    const btn = document.createElement('div');
                    btn.className = "p-3 border rounded-xl text-center text-sm font-bold cursor-pointer bg-gray-50 card-week";
                    btn.innerText = w;
                    btn.onclick = () => {
                        document.getElementById('selectedWeek').value = w;
                        Array.from(cont.children).forEach(c => c.classList.remove('selected'));
                        btn.classList.add('selected');
                    };
                    cont.appendChild(btn);
                });
            }).getAvailableWeeks(user.group);
        }

        function loadWeeksAdmin() {
            google.script.run.withSuccessHandler(weeks => {
                const cont = document.getElementById('adminWeekList');
                cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-gray-400'>Tiada rekod.</p>";
                weeks.forEach(w => {
                    cont.innerHTML += `<div class="p-4 border rounded-xl font-bold text-gray-700 shadow-sm">${w}</div>`;
                });
            }).getAvailableWeeks(user.group);
        }

        function addWeek() {
            const n = prompt("Nama Minggu (Cth: MINGGU 1):");
            if(!n) return;
            showLoading(true);
            google.script.run.withSuccessHandler(res => {
                showLoading(false);
                alert(res.message);
                loadWeeksAdmin();
            }).backendCreateFolder(n, user.group);
        }

        function uploadRPH() {
            const wk = document.getElementById('selectedWeek').value;
            const f = document.getElementById('fileInp').files[0];
            if(!wk || !f) return alert("Pilih minggu dan fail!");
            
            showLoading(true);
            const reader = new FileReader();
            reader.onload = function(e) {
                const d = { data: e.target.result.split(',')[1], mimeType: f.type, fileName: f.name, week: wk, group: user.group };
                google.script.run.withSuccessHandler(url => {
                    showLoading(false);
                    alert("Berjaya Hantar!");
                    location.reload();
                }).backendUpload(d);
            };
            reader.readAsDataURL(f);
        }

        function accessMaster() {
            if(prompt("Kod Master:") === "101010") {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('masterPanel').classList.add('active-tab');
            }
        }

        function doSaveGroup() {
            const gn = document.getElementById('mGName').value;
            const ga = document.getElementById('mGAdmin').value;
            const gm = document.getElementById('mGMembers').value;
            showLoading(true);
            google.script.run.withSuccessHandler(res => {
                showLoading(false);
                alert(res);
                location.reload();
            }).saveGroup(gn, ga, gm);
        }
    </script>
</body>
</html>
