<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eRPH Cloud 551</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 9999; color: white; }
        .tab-content { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab { display: block; }
        .card-week.selected { border-color: #6366f1 !important; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important; color: #312e81 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .star-icon { cursor: pointer; transition: transform 0.2s, color 0.2s; }
        .star-icon:hover { color: #fbbf24; transform: scale(1.2); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .glass-nav { background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-[conic-gradient(at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-purple-900 to-slate-900 min-h-screen font-sans selection:bg-pink-500 selection:text-white">

    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-pink-500 mb-4"></div>
            <p class="font-black text-xl text-white tracking-[0.2em] animate-pulse" id="loadText">SEDANG MEMPROSES...</p>
        </div>
    </div>

    <nav class="glass-nav text-white p-4 sticky top-0 z-50 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center max-w-2xl">
            <div class="flex items-center space-x-2">
                <div class="bg-gradient-to-br from-pink-500 to-orange-400 p-2 rounded-lg shadow-lg">
                    <span class="material-icons text-white">cloud_done</span>
                </div>
                <span class="font-black uppercase tracking-widest text-lg text-transparent bg-clip-text bg-gradient-to-r from-pink-200 to-indigo-200 drop-shadow-sm">eRPH Cloud</span>
            </div>
            <div class="flex space-x-2">
                <button id="groupBtn" onclick="showGroupSelection()" class="hidden bg-indigo-600/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-indigo-500 hover:scale-105 transition-transform">Kumpulan</button>
                <button id="switchRoleBtn" onclick="switchRoleView()" class="hidden bg-green-500/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-green-600 hover:scale-105 transition-transform">Mod Guru</button>
                <button id="changePassBtn" onclick="changeOwnPassword()" class="hidden bg-yellow-500/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-yellow-400 hover:scale-105 transition-transform">Pass</button>
                <button id="logoutBtn" onclick="doLogout()" class="hidden bg-red-500/80 px-4 py-2 rounded-full text-xs font-bold shadow-lg hover:bg-red-600 hover:scale-105 transition-transform">Keluar</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-xl pb-20">
        <div id="loginSection" class="glass-panel p-8 rounded-3xl shadow-2xl mt-8 transform transition-all hover:shadow-[0_20px_50px_rgba(8,_112,_184,_0.7)]">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-black text-slate-800 mb-1">SELAMAT DATANG</h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Portal Pengurusan RPH Digital</p>
            </div>
            <div class="flex justify-around mb-8 border-b pb-2">
                <button onclick="toggleAuth('login')" id="btnTabLogin" class="font-bold text-indigo-900 border-b-4 border-indigo-600 pb-2 transition-all">LOG MASUK</button>
                <button onclick="toggleAuth('signup')" id="btnTabSignup" class="font-bold text-gray-400 pb-2 hover:text-indigo-500 transition-all">DAFTAR</button>
            </div>
            <div id="divLogin">
                <input type="text" id="loginIC" placeholder="No. Kad Pengenalan" class="w-full border-2 border-gray-100 p-4 rounded-xl mb-4 bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition-all shadow-inner font-bold text-gray-700">
                <input type="password" id="loginPass" placeholder="Kata Laluan" class="w-full border-2 border-gray-100 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition-all shadow-inner font-bold text-gray-700">
                
                <!-- LOCK ICON TOGGLE -->
                <div class="flex items-center mb-6 justify-end cursor-pointer transition-colors select-none" onclick="toggleRemember()">
                    <div id="lockContainer" class="flex items-center text-gray-400 hover:text-indigo-600 bg-gray-100 px-3 py-1 rounded-full">
                         <span id="lockIcon" class="material-icons text-sm mr-1">lock_open</span>
                         <span id="lockText" class="text-[10px] font-bold uppercase tracking-wider">Ingat Saya</span>
                    </div>
                    <input type="checkbox" id="chkRemember" class="hidden">
                </div>

                <button onclick="doAction('login')" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black shadow-lg hover:shadow-indigo-500/50 hover:scale-[1.02] transition-all tracking-wider text-sm">MASUK SISTEM</button>
                <button onclick="accessMaster()" class="w-full mt-6 text-[10px] text-gray-400 uppercase tracking-widest font-bold hover:text-indigo-500">Akses Master Admin</button>
            </div>
            <div id="divSignup" class="hidden space-y-4">
                <input type="text" id="regName" placeholder="Nama Penuh" class="w-full border-2 border-gray-100 p-4 rounded-xl bg-gray-50 focus:border-indigo-500 outline-none font-bold">
                <input type="text" id="regIC" placeholder="No. Kad Pengenalan (Tanpa -)" class="w-full border-2 border-gray-100 p-4 rounded-xl bg-gray-50 focus:border-indigo-500 outline-none font-bold">
                <input type="password" id="regPass" placeholder="Cipta Kata Laluan" class="w-full border-2 border-gray-100 p-4 rounded-xl bg-gray-50 focus:border-indigo-500 outline-none font-bold">
                <button onclick="doAction('signup')" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold hover:bg-slate-900 transition-all shadow-lg">HANTAR PENDAFTARAN</button>
            </div>
        </div>

        <!-- NEW: GROUP SELECTION PANEL -->
        <div id="groupSelectionPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <h2 class="text-xl font-black text-indigo-900 mb-4 uppercase text-center tracking-wide">Pilih Kumpulan Anda</h2>
            <div id="groupListContainer" class="space-y-3">
                <!-- Buttons injected here -->
            </div>
        </div>

        <div id="guruPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight" id="welcomeGuru">Nama</h2>
                    <p class="text-sm text-slate-500 mb-6 font-medium">Kumpulan: <span id="guruGroup" class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"></span></p>
                </div>
                <div id="myStats" class="bg-gradient-to-br from-yellow-100 to-orange-100 p-3 rounded-2xl text-center border border-yellow-200 shadow-sm">
                    <p class="text-[9px] font-black text-yellow-800 uppercase tracking-wide">Markah Terkumpul</p>
                    <div class="flex items-center justify-center space-x-1 mt-1">
                        <span class="material-icons text-yellow-600 text-sm">star</span>
                        <span id="myWeeklyStars" class="font-black text-2xl text-yellow-900">0</span>
                    </div>
                </div>
            </div>
            
            <div id="leaderboardArea" class="mb-6 bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-2xl border border-indigo-100 hidden">
                <h3 class="text-xs font-bold text-indigo-900 uppercase mb-2 flex items-center"><span class="material-icons text-sm mr-1">emoji_events</span> TOP 3 TERKUMPUL</h3>
                <div id="leaderboardList" class="space-y-2"></div>
            </div>

            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">1. Pilih Minggu</label>
            <div id="weekList" class="grid grid-cols-2 gap-3 mb-6 mt-2 p-3 bg-slate-50/50 rounded-2xl border border-slate-200"></div>
            
            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">2. Muat Naik Fail RPH</label>
            <div class="relative mt-2 mb-4">
                <input type="file" id="fileInp" class="w-full p-4 border-2 border-dashed border-indigo-300 rounded-2xl bg-indigo-50/30 text-sm font-bold text-indigo-900 focus:bg-white transition-all">
                <div class="absolute top-0 right-0 p-4 pointer-events-none">
                    <span class="material-icons text-indigo-300">cloud_upload</span>
                </div>
            </div>
            <input type="hidden" id="selectedWeek">
            <button onclick="uploadRPH()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black shadow-lg hover:shadow-indigo-500/50 hover:scale-[1.02] transition-all">HANTAR RPH</button>

            <div id="teacherFilesArea" class="mt-8 pt-6 border-t border-slate-200 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-800 flex items-center uppercase tracking-wide"><span class="material-icons text-indigo-500 mr-1">history</span> Sejarah Hantaran:</h3>
                    <span id="lblTeacherWeek" class="bg-indigo-100 text-indigo-800 text-xs font-black px-3 py-1 rounded-full">-</span>
                </div>
                <div id="teacherFileList" class="space-y-3"></div>
            </div>
        </div>

        <div id="adminPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="adminGroupName" class="text-xl font-black text-slate-800 uppercase">Nama Sekolah</h2>
                <button onclick="doAction('createWeek')" class="bg-indigo-600 text-white p-2 px-4 rounded-xl flex items-center shadow-lg hover:bg-indigo-500 font-bold text-xs"><span class="material-icons text-sm mr-1">add</span> Minggu</button>
            </div>
            
            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Senarai Folder Minggu</label>
            <div id="adminWeekList" class="grid grid-cols-2 gap-3 bg-slate-50/50 p-4 rounded-2xl mb-6 mt-2 border border-slate-200"></div>

            <div id="submissionArea" class="hidden mt-6">
                <h3 class="font-bold text-slate-800 border-b pb-2 mb-4 flex justify-between items-center">
                    <span class="uppercase tracking-wide text-sm">Folder Guru</span>
                    <span id="viewingWeek" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-[10px] font-black"></span>
                </h3>
                <div id="adminTeacherGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div id="masterPanel" class="tab-content bg-slate-900/95 backdrop-blur p-8 rounded-3xl text-white mt-6 shadow-2xl border border-slate-700">
            <h2 class="text-2xl font-black text-red-500 mb-6 flex items-center tracking-tighter"><span class="material-icons mr-2">admin_panel_settings</span> KAWALAN PUSAT</h2>
            
            <!-- SENARAI USER -->
            <div class="mb-10 bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-inner">
                <h3 class="text-xs font-black text-blue-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Senarai Pengguna (IC)</h3>
                <div id="masterUserList" class="space-y-2 h-64 overflow-auto custom-scrollbar">
                    <p class="text-xs text-slate-500 animate-pulse">Memuatkan data pengguna...</p>
                </div>
            </div>

            <div class="mb-10">
                <h3 class="text-xs font-black text-slate-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Kumpulan Berdaftar</h3>
                <div id="masterGroupList" class="space-y-3">
                    <p class="text-xs text-slate-500 animate-pulse">Memuatkan data dari pangkalan data...</p>
                </div>
            </div>
            
            <div class="mb-10">
                 <h3 class="text-xs font-black text-yellow-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Global Leaderboard</h3>
                 <div id="masterStatsList" class="space-y-2 bg-slate-800 p-4 rounded-xl h-48 overflow-auto border border-slate-700">
                     <p class="text-xs text-slate-500 italic">Sila tunggu...</p>
                 </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-inner">
                <h3 id="masterFormTitle" class="text-sm font-bold text-green-400 mb-4 flex items-center uppercase tracking-wide"><span class="material-icons text-sm mr-1">add_circle</span> Daftar Kumpulan Baharu</h3>
                <div class="space-y-4 text-black">
                    <input type="hidden" id="mGMode" value="new">
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Nama Kumpulan (Unik)</label>
                        <input type="text" id="mGName" placeholder="Contoh: SK BANDAR BARU" class="w-full p-4 rounded-xl mt-1 bg-slate-100 focus:bg-white transition-all font-bold">
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">IC Admin Kumpulan</label>
                        <input type="text" id="mGAdmin" placeholder="No. IC Admin" class="w-full p-4 rounded-xl mt-1 bg-slate-100 focus:bg-white transition-all font-bold">
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Senarai IC Ahli (Guru)</label>
                        <textarea id="mGMembers" placeholder="pisahkan, dengan, koma" class="w-full p-4 rounded-xl h-24 mt-1 bg-slate-100 focus:bg-white transition-all leading-relaxed font-mono text-xs"></textarea>
                    </div>

                    <div class="flex space-x-2 pt-2">
                        <button id="btnSaveGroup" onclick="submitMasterGroup()" class="flex-1 bg-red-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-red-500 transition-colors">DAFTAR KUMPULAN</button>
                        <button id="btnCancelEdit" onclick="resetMasterForm()" class="hidden bg-slate-500 text-white px-6 py-4 rounded-xl font-bold shadow-lg hover:bg-slate-400 transition-colors">BATAL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzD5YBU-G1dPD_SfjO5sPSK2Rj8XLFcrzXhbqsB7nepqHmdWbOkNuxsCymeQgHh0yEB/exec";
        
        let user = { email: "", groups: [], activeGroup: "", activeRole: "", name: "" };

        // --- SESSION RESTORE LOGIC ---
        try {
            // RESTORE LOCK STATE PERSISTENCE (Added for Tighter Security)
            if(localStorage.getItem('erph_lock_ui') === 'true') {
                document.addEventListener("DOMContentLoaded", () => {
                    const chk = document.getElementById('chkRemember');
                    const icon = document.getElementById('lockIcon');
                    const cnt = document.getElementById('lockContainer');
                    if(chk) {
                        chk.checked = true;
                        icon.innerText = "lock";
                        cnt.classList.remove('text-gray-400');
                        cnt.classList.add('text-indigo-600');
                    }
                });
            }

            const savedSess = localStorage.getItem('erph_session');
            if(savedSess) {
                const s = JSON.parse(savedSess);
                if(s && s.ic) {
                    user = s;
                    // Force lock state true if logged in (Syncs state)
                    localStorage.setItem('erph_lock_ui', 'true');
                    
                    // UI Restore
                    document.addEventListener("DOMContentLoaded", () => {
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('logoutBtn').classList.remove('hidden');
                        document.getElementById('changePassBtn').classList.remove('hidden');
                        showGroupSelection();
                    });
                }
            }
        } catch(e) { console.log("No session"); }

        function showLoading(s, txt="SEDANG MEMPROSES...") { 
            document.getElementById('loading').style.display = s ? 'flex' : 'none'; 
            document.getElementById('loadText').innerText = txt;
        }
        
        function toggleRemember() {
            const chk = document.getElementById('chkRemember');
            const icon = document.getElementById('lockIcon');
            const cnt = document.getElementById('lockContainer');
            
            chk.checked = !chk.checked;
            
            if(chk.checked) {
                icon.innerText = "lock";
                cnt.classList.remove('text-gray-400');
                cnt.classList.add('text-indigo-600');
                localStorage.setItem('erph_lock_ui', 'true'); // Save Persistent Lock State
            } else {
                icon.innerText = "lock_open";
                cnt.classList.add('text-gray-400');
                cnt.classList.remove('text-indigo-600');
                localStorage.setItem('erph_lock_ui', 'false'); // Save Persistent Unlock State
            }
        }

        function doLogout() {
            localStorage.removeItem('erph_session');
            location.reload();
        }

        function toggleAuth(mode) {
            document.getElementById('divLogin').classList.toggle('hidden', mode === 'signup');
            document.getElementById('divSignup').classList.toggle('hidden', mode === 'login');
            document.getElementById('btnTabLogin').className = mode === 'login' ? "font-bold text-indigo-900 border-b-4 border-indigo-600 pb-2 transition-all" : "font-bold text-gray-400 pb-2 hover:text-indigo-500 transition-all";
            document.getElementById('btnTabSignup').className = mode === 'signup' ? "font-bold text-indigo-900 border-b-4 border-indigo-600 pb-2 transition-all" : "font-bold text-gray-400 pb-2 hover:text-indigo-500 transition-all";
        }

        async function runAPI(actionName, payloadData) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: actionName, data: payloadData }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    redirect: 'follow'
                });
                return await res.json();
            } catch (err) { 
                Swal.fire({ icon: 'error', title: 'Ralat Sambungan', text: 'Sila periksa internet anda.' });
                return null;
            }
        }

        async function doAction(mode) {
            if (mode === 'login') {
                const ic = document.getElementById('loginIC').value.trim();
                const pass = document.getElementById('loginPass').value.trim();
                if (!ic || !pass) return Swal.fire('Ralat', 'Sila isi IC dan Kata Laluan', 'warning');

                showLoading(true, "MENYEMAK ID...");
                const res = await runAPI('login', { ic: ic, password: pass });
                showLoading(false);

                if (res && res.found) {
                    user = res;
                    user.ic = ic; // Ensure IC is saved

                    // --- FIX: SAVING SESSION IF CHECKBOX CHECKED ---
                    if (document.getElementById('chkRemember').checked) {
                        localStorage.setItem('erph_session', JSON.stringify(user));
                    } else {
                        localStorage.removeItem('erph_session');
                    }
                    
                    Swal.fire({ icon: 'success', title: 'Berjaya!', text: 'Selamat datang ' + user.name, timer: 1500, showConfirmButton: false });
                    
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.getElementById('changePassBtn').classList.remove('hidden');
                    showGroupSelection();
                } else {
                    Swal.fire('Gagal', res ? res.message : 'ID atau Kata Laluan salah', 'error');
                }

            } else if (mode === 'signup') {
                const name = document.getElementById('regName').value.trim();
                const ic = document.getElementById('regIC').value.trim();
                const pass = document.getElementById('regPass').value.trim();
                
                if(!name || !ic || !pass) return Swal.fire('Error', 'Sila isi semua info', 'warning');
                
                showLoading(true, "MENDAFTAR...");
                const res = await runAPI('signup', { name: name, ic: ic, pass: pass });
                showLoading(false);
                
                Swal.fire('Status', res, 'info');
                toggleAuth('login');
            }
        }

        function showGroupSelection() {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById('groupSelectionPanel').style.display = 'block';
            document.getElementById('groupBtn').classList.remove('hidden');
            
            const container = document.getElementById('groupListContainer');
            container.innerHTML = '';
            
            if(user.groups && user.groups.length > 0) {
                 user.groups.forEach(g => {
                     const btn = document.createElement('button');
                     btn.className = "w-full text-left p-4 rounded-xl flex justify-between items-center transition-all shadow-md hover:scale-[1.02] mb-2 " + 
                                     (g.role === 'ADMIN_KUMPULAN' ? "bg-gradient-to-r from-indigo-100 to-white border-l-4 border-indigo-600 text-indigo-900" : "bg-white border-l-4 border-emerald-500 text-emerald-900");
                     btn.innerHTML = `<div><span class="font-black uppercase text-sm">${g.group}</span><br><span class="text-[10px] uppercase tracking-wider opacity-70 font-bold">${g.role.replace('_', ' ')}</span></div><span class="material-icons">chevron_right</span>`;
                     btn.onclick = () => loadGroup(g.group, g.role);
                     container.appendChild(btn);
                 });
            } else {
                container.innerHTML = `<div class="text-center p-6 bg-red-50 rounded-xl border border-red-100"><span class="material-icons text-red-400 text-4xl mb-2">sentiment_dissatisfied</span><p class="text-red-800 font-bold text-sm">Tiada Kumpulan.</p><p class="text-xs text-red-600 mt-1">Hubungi admin sekolah anda.</p></div>`;
            }
        }

        async function loadGroup(groupName, role) {
            user.activeGroup = groupName;
            user.activeRole = role;
            
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            
            if(role === 'ADMIN_KUMPULAN') {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminGroupName').innerText = groupName;
                document.getElementById('switchRoleBtn').classList.remove('hidden');
                loadAdminWeeks();
            } else {
                document.getElementById('guruPanel').style.display = 'block';
                document.getElementById('welcomeGuru').innerText = user.name;
                document.getElementById('guruGroup').innerText = groupName;
                loadGuruWeeks();
            }
        }

        async function loadGuruWeeks() {
            showLoading(true, "MEMUATKAN DATA...");
            const weekDiv = document.getElementById('weekList');
            weekDiv.innerHTML = '<p class="text-xs text-slate-400 p-2 col-span-2 text-center">Sedang mengambil data...</p>';
            
            const weeks = await runAPI('getWeeks', { group: user.activeGroup, role: 'GURU', userName: user.name });
            showLoading(false);
            
            weekDiv.innerHTML = '';
            if(!weeks || weeks.length === 0) {
                 weekDiv.innerHTML = '<p class="text-xs text-slate-400 p-2 col-span-2 text-center italic">Tiada minggu dibuka.</p>';
                 return;
            }

            weeks.forEach(w => {
                let colorClass = "bg-white border-slate-200 text-slate-600";
                if (w.status === 'RED') colorClass = "bg-red-50 border-red-200 text-red-700";
                else if (w.status === 'YELLOW') colorClass = "bg-yellow-50 border-yellow-200 text-yellow-700";
                else if (w.status === 'BLUE') colorClass = "bg-blue-50 border-blue-200 text-blue-700";

                const btn = document.createElement('div');
                btn.className = `card-week p-3 rounded-xl border-2 text-center cursor-pointer font-bold text-xs transition-all hover:scale-105 ${colorClass}`;
                btn.innerText = w.name;
                btn.onclick = () => selectWeek(btn, w.name);
                weekDiv.appendChild(btn);
            });
            
            // Load leaderboard snippet
            loadLeaderboard();
        }

        function selectWeek(el, weekName) {
            document.querySelectorAll('.card-week').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedWeek').value = weekName;
            loadTeacherFiles(weekName);
        }

        async function uploadRPH() {
            const fileInp = document.getElementById('fileInp');
            const week = document.getElementById('selectedWeek').value;
            
            if(!week) return Swal.fire('Ops', 'Sila pilih minggu dahulu.', 'warning');
            if(fileInp.files.length === 0) return Swal.fire('Ops', 'Sila pilih fail RPH.', 'warning');
            
            const file = fileInp.files[0];
            if(file.size > 5 * 1024 * 1024) return Swal.fire('Ralat', 'Saiz fail maksima 5MB', 'error');

            showLoading(true, "MUAT NAIK...");
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result.split(',')[1];
                const res = await runAPI('upload', {
                    group: user.activeGroup,
                    week: week,
                    userName: user.name,
                    fileName: file.name,
                    mimeType: file.type,
                    data: base64
                });
                
                showLoading(false);
                if(res && res.includes('http')) {
                    Swal.fire('Berjaya', 'RPH berjaya dihantar!', 'success');
                    fileInp.value = '';
                    loadTeacherFiles(week);
                } else {
                    Swal.fire('Ralat', res || 'Gagal upload', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        async function loadTeacherFiles(week) {
            document.getElementById('teacherFilesArea').classList.remove('hidden');
            document.getElementById('lblTeacherWeek').innerText = week;
            document.getElementById('teacherFileList').innerHTML = '<p class="text-xs animate-pulse">Memuatkan rekod...</p>';
            
            const res = await runAPI('getTeacherFiles', { group: user.activeGroup, week: week, userName: user.name });
            
            if(res && res.status === 'success') {
                const list = document.getElementById('teacherFileList');
                list.innerHTML = '';
                document.getElementById('myWeeklyStars').innerText = res.cumulativeScore;
                
                if(res.files.length === 0) {
                     list.innerHTML = '<p class="text-xs text-slate-400 italic">Tiada fail dihantar.</p>';
                     return;
                }
                
                res.files.forEach(f => {
                     let stars = "";
                     for(let i=0; i<5; i++) {
                         stars += `<span class="material-icons text-[10px] ${i < f.rating ? 'text-yellow-400' : 'text-gray-200'}">star</span>`;
                     }
                     
                     let aiBadge = "";
                     if (f.aiRating && f.aiRating > 0) {
                         aiBadge = `<span class="ml-2 bg-indigo-100 text-indigo-700 text-[9px] font-black px-1.5 rounded">AI: ${f.aiRating}/5</span>`;
                     }

                     const div = document.createElement('div');
                     div.className = "bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center";
                     div.innerHTML = `<div><a href="${f.url}" target="_blank" class="font-bold text-xs text-indigo-600 hover:underline truncate block w-48">${f.name}</a>` +
                                     `<div class="flex mt-1">${stars}${aiBadge}</div>` +
                                     (f.comment ? `<p class="text-[10px] text-slate-500 mt-1 italic">"${f.comment}"</p>` : '') + `</div>` +
                                     `<span class="material-icons text-green-400 text-sm">check_circle</span>`;
                     list.appendChild(div);
                });
            } else {
                document.getElementById('teacherFileList').innerHTML = '<p class="text-xs text-red-400">Gagal memuatkan rekod.</p>';
            }
        }

        async function loadLeaderboard() {
             const res = await runAPI('getLeaderboard', { group: user.activeGroup });
             if(res.status === 'success' && res.data.length > 0) {
                 document.getElementById('leaderboardArea').classList.remove('hidden');
                 const div = document.getElementById('leaderboardList');
                 div.innerHTML = '';
                 res.data.forEach((d, i) => {
                     div.innerHTML += `<div class="flex justify-between items-center text-xs font-bold text-slate-600 border-b border-indigo-100 pb-1 last:border-0"><span>${i+1}. ${d.name}</span><span class="text-indigo-600">${d.score} <span class="text-[8px]">★</span></span></div>`;
                 });
             }
        }

        // --- ADMIN FUNCTIONS ---
        async function loadAdminWeeks() {
            const div = document.getElementById('adminWeekList');
            div.innerHTML = '<p class="text-xs text-slate-400">Memuatkan...</p>';
            const weeks = await runAPI('getWeeks', { group: user.activeGroup, role: 'ADMIN' });
            div.innerHTML = '';
            
            if(weeks.length === 0) div.innerHTML = '<p class="text-xs text-slate-400">Tiada minggu dicipta.</p>';
            
            weeks.forEach(w => {
                let color = "bg-white text-slate-600";
                if(w.status === 'RED') color = "bg-red-50 text-red-600 border-red-200";
                else if(w.status === 'YELLOW') color = "bg-yellow-50 text-yellow-600 border-yellow-200";
                
                const btn = document.createElement('button');
                btn.className = `p-3 rounded-xl border font-bold text-xs shadow-sm hover:scale-105 transition-transform ${color}`;
                btn.innerText = w.name;
                btn.onclick = () => loadAdminSubmission(w.name);
                div.appendChild(btn);
            });
        }

        async function loadAdminSubmission(week) {
            document.getElementById('submissionArea').classList.remove('hidden');
            document.getElementById('viewingWeek').innerText = week;
            const grid = document.getElementById('adminTeacherGrid');
            grid.innerHTML = '<p class="text-xs animate-pulse">Sedang mengambil data...</p>';
            
            const res = await runAPI('getAdminSubmissionsData', { group: user.activeGroup, week: week });
            grid.innerHTML = '';
            
            if(res.status === 'success') {
                res.data.forEach(t => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100";
                    
                    let filesHtml = "";
                    if(t.files.length === 0) filesHtml = '<p class="text-[10px] text-red-400 italic">Tiada fail.</p>';
                    else {
                        t.files.forEach(f => {
                            filesHtml += `<div class="mb-2 pb-2 border-b last:border-0 border-slate-50">` +
                                         `<a href="${f.url}" target="_blank" class="text-xs font-bold text-blue-600 hover:underline block truncate">${f.name}</a>` +
                                         `<div class="flex justify-between items-center mt-1">` +
                                            `<div class="flex">` + 
                                                [1,2,3,4,5].map(s => `<span onclick="rateFile('${t.teacherName}','${f.id}','${f.name}',${s})" class="material-icons text-sm star-icon ${s <= f.rating ? 'text-yellow-400' : 'text-gray-200'}">star</span>`).join('') +
                                            `</div>` +
                                            `<span class="text-[9px] font-bold text-slate-400 ml-1">Manual</span>` +
                                         `</div>` +
                                         (f.aiRating ? `<div class="mt-1 text-[9px] font-bold text-indigo-500 bg-indigo-50 inline-block px-1 rounded">AI SCORE: ${f.aiRating}/5</div>` : '') +
                                         `<textarea id="comment_${f.id}" placeholder="Ulasan..." class="w-full text-[10px] mt-2 p-2 bg-slate-50 rounded border">${f.comment || ''}</textarea>` +
                                         `<button onclick="saveComment('${t.teacherName}','${f.id}','${f.name}')" class="mt-1 bg-slate-800 text-white text-[9px] px-2 py-1 rounded w-full">SIMPAN ULASAN</button>` +
                                         `</div>`;
                        });
                    }
                    
                    card.innerHTML = `<h4 class="font-black text-sm text-slate-800 mb-2 border-b pb-1">${t.teacherName}</h4>` + filesHtml;
                    grid.appendChild(card);
                });
            }
        }

        async function rateFile(tName, fId, fName, rating) {
            const week = document.getElementById('viewingWeek').innerText;
            await runAPI('rateStar', {
                group: user.activeGroup,
                week: week,
                teacherName: tName,
                fileId: fId,
                fileName: fName,
                rating: rating
            });
            loadAdminSubmission(week); // Refresh to show updated stars
        }

        async function saveComment(tName, fId, fName) {
            const comm = document.getElementById('comment_'+fId).value;
            const week = document.getElementById('viewingWeek').innerText;
            
            Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
            
            const res = await runAPI('saveComment', {
                group: user.activeGroup,
                week: week,
                teacherName: tName,
                fileId: fId,
                fileName: fName,
                comment: comm
            });
            
            Swal.close();
            if(res.status === 'success') {
                if(res.aiError) Swal.fire('Disimpan', 'Komen disimpan tapi AI gagal: ' + res.aiError, 'warning');
                else Swal.fire('Berjaya', 'Komen disimpan & AI telah menilai!', 'success');
                loadAdminSubmission(week);
            } else {
                Swal.fire('Ralat', res.message, 'error');
            }
        }
        
        // --- UTIL / MASTER FUNCTIONS ---
        function switchRoleView() {
             // Toggle logic for Admin to see Guru view
             if(user.activeRole === 'ADMIN_KUMPULAN') {
                 // Temporarily view as guru
                 loadGroup(user.activeGroup, 'GURU');
                 // Change button text/color to indicate return
                 const btn = document.getElementById('switchRoleBtn');
                 btn.innerText = "Kembali Admin";
                 btn.classList.remove('bg-green-500/80');
                 btn.classList.add('bg-slate-700');
                 btn.onclick = () => {
                     loadGroup(user.activeGroup, 'ADMIN_KUMPULAN');
                     btn.innerText = "Mod Guru";
                     btn.classList.add('bg-green-500/80');
                     btn.classList.remove('bg-slate-700');
                     btn.onclick = switchRoleView;
                 };
             }
        }

        function accessMaster() {
            Swal.fire({
                title: 'Akses Master',
                input: 'password',
                inputPlaceholder: 'Kod Rahsia',
                showCancelButton: true
            }).then((res) => {
                if(res.isConfirmed && res.value === 'master123') {
                    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                    document.getElementById('masterPanel').style.display = 'block';
                    loadMasterData();
                } else if (res.isConfirmed) {
                    Swal.fire('Akses Ditolak', 'Kod salah', 'error');
                }
            });
        }

        async function loadMasterData() {
             const uList = document.getElementById('masterUserList');
             const res = await runAPI('getAllUsers', {});
             if(res.status === 'success') {
                 uList.innerHTML = '';
                 res.data.forEach(u => {
                     uList.innerHTML += `<div class="flex justify-between items-center text-[10px] bg-slate-700 p-2 rounded">` +
                                        `<span><b class="text-blue-300">${u.ic}</b> - ${u.name}</span>` +
                                        `<div><button onclick="resetUserPass('${u.ic}')" class="text-yellow-400 hover:underline mr-2">RESET</button>` +
                                        `<button onclick="deleteUser('${u.ic}')" class="text-red-400 hover:underline">PADAM</button></div>` +
                                        `</div>`;
                 });
             }
             // Load groups...
             const gList = document.getElementById('masterGroupList');
             const resG = await runAPI('getAllGroups', {});
             if(resG.status === 'success') {
                 gList.innerHTML = '';
                 resG.data.forEach(g => {
                     gList.innerHTML += `<div class="bg-slate-700 p-3 rounded-xl border-l-4 border-green-500 flex justify-between items-center">` +
                                        `<div><h4 class="font-bold text-sm text-white">${g.groupName}</h4><p class="text-[10px] text-slate-400">Admin: ${g.adminEmail}</p></div>` +
                                        `<div class="space-x-1">` +
                                        `<button onclick="editGroup('${g.groupName}','${g.adminEmail}','${g.members}')" class="text-xs bg-blue-600 px-2 py-1 rounded">EDIT</button>` +
                                        `<button onclick="deleteGroup('${g.groupName}')" class="text-xs bg-red-600 px-2 py-1 rounded">HAPUS</button>` +
                                        `</div></div>`;
                 });
             }
             // Global stats
             const sList = document.getElementById('masterStatsList');
             const resS = await runAPI('getGlobalStats', {});
             if(resS.status === 'success') {
                 sList.innerHTML = '';
                 resS.data.forEach((x, i) => {
                     sList.innerHTML += `<div class="flex justify-between text-[10px] border-b border-slate-600 pb-1 mb-1"><span>${i+1}. ${x.name} (${x.group})</span><span class="text-yellow-400 font-bold">${x.total} ★</span></div>`;
                 });
             }
        }

        function editGroup(name, admin, members) {
            document.getElementById('mGMode').value = 'edit';
            document.getElementById('mGName').value = name;
            document.getElementById('mGName').disabled = true;
            document.getElementById('mGAdmin').value = admin;
            document.getElementById('mGMembers').value = members;
            document.getElementById('masterFormTitle').innerText = "EDIT KUMPULAN";
            document.getElementById('btnSaveGroup').innerText = "KEMASKINI";
            document.getElementById('btnSaveGroup').className = "flex-1 bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-blue-500 transition-colors";
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            window.scrollTo(0, document.body.scrollHeight);
        }

        function resetMasterForm() {
            document.getElementById('mGMode').value = 'new';
            document.getElementById('mGName').value = '';
            document.getElementById('mGName').disabled = false;
            document.getElementById('mGAdmin').value = '';
            document.getElementById('mGMembers').value = '';
            document.getElementById('masterFormTitle').innerHTML = '<span class="material-icons text-sm mr-1">add_circle</span> Daftar Kumpulan Baharu';
            document.getElementById('btnSaveGroup').innerText = "DAFTAR KUMPULAN";
            document.getElementById('btnSaveGroup').className = "flex-1 bg-red-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-red-500 transition-colors";
            document.getElementById('btnCancelEdit').classList.add('hidden');
        }

        async function submitMasterGroup() {
            const mode = document.getElementById('mGMode').value;
            const name = document.getElementById('mGName').value;
            const admin = document.getElementById('mGAdmin').value;
            const members = document.getElementById('mGMembers').value;
            
            if(!name || !admin) return Swal.fire('Error', 'Nama & Admin wajib', 'warning');
            
            showLoading(true, "MENYIMPAN...");
            const action = mode === 'new' ? 'saveGroup' : 'updateGroup';
            const res = await runAPI(action, { groupName: name, adminEmail: admin, memberEmailsStr: members });
            showLoading(false);
            
            Swal.fire('Info', typeof res === 'string' ? res : res.message, 'info');
            if(mode === 'edit') resetMasterForm();
            loadMasterData();
        }

        async function deleteGroup(name) {
            Swal.fire({
                title: 'Padam Kumpulan?', text: name,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'
            }).then(async (r) => {
                if(r.isConfirmed) {
                    showLoading(true, "MEMADAM...");
                    await runAPI('deleteGroup', { groupName: name });
                    showLoading(false);
                    loadMasterData();
                }
            });
        }

        async function resetUserPass(ic) {
             if(confirm("Reset password ke 'skselama1008'?")) {
                 await runAPI('resetUserPassword', { ic: ic });
                 alert("Direset.");
             }
        }
        
        async function deleteUser(ic) {
             if(confirm("Padam pengguna ini selamanya?")) {
                 await runAPI('deleteUser', { ic: ic });
                 loadMasterData();
             }
        }
        
        function changeOwnPassword() {
             Swal.fire({
                 title: 'Tukar Kata Laluan',
                 html: '<input id="swalPass" class="swal2-input" placeholder="Kata Laluan Baharu">',
                 showCancelButton: true
             }).then(async (res) => {
                 if(res.isConfirmed) {
                     const newP = document.getElementById('swalPass').value;
                     if(newP) {
                         showLoading(true);
                         await runAPI('changePassword', { ic: user.ic, newPass: newP });
                         showLoading(false);
                         Swal.fire('Berjaya', 'Kata laluan ditukar.', 'success');
                     }
                 }
             });
        }
    </script>
</body>
</html>
