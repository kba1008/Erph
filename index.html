<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eRPH SK SELAMA (K) - SSO Gmail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://acrobatservices.adobe.com/view-sdk/viewer.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 9999; color: white; }
        .tab-content { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab { display: block; }
        .card-week.selected { border-color: #6366f1 !important; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important; color: #312e81 !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .star-icon { cursor: pointer; transition: transform 0.2s, color 0.2s; }
        .star-icon:hover { color: #fbbf24; transform: scale(1.2); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .glass-nav { background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-[conic-gradient(at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-purple-900 to-slate-900 min-h-screen font-sans selection:bg-pink-500 selection:text-white" onclick="closeContext()">

    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-pink-500 mb-4"></div>
            <p class="font-black text-xl text-white tracking-[0.2em] animate-pulse" id="loadText">SEDANG MEMPROSES...</p>
        </div>
    </div>

    <div id="folderCtxMenu" class="fixed z-[999] bg-white rounded-xl shadow-2xl border border-gray-100 w-48 py-2 hidden transform transition-all scale-95 origin-top-left">
        <div onclick="triggerRename()" class="px-4 py-3 hover:bg-indigo-50 hover:text-indigo-600 cursor-pointer flex items-center text-sm font-bold text-gray-700 transition-colors">
            <span class="material-icons text-sm mr-3">edit</span>Namakan Semula
        </div>
        <div onclick="triggerDelete()" class="px-4 py-3 hover:bg-red-50 hover:text-red-600 cursor-pointer flex items-center text-sm font-bold text-gray-700 border-t border-gray-100 transition-colors">
            <span class="material-icons text-sm mr-3">delete</span>Padam Folder
        </div>
    </div>

    <div id="pdfModal" class="fixed inset-0 z-[100] hidden bg-black/95 flex flex-col">
        <div class="flex justify-between items-center p-3 bg-slate-900 text-white border-b border-slate-700 shadow-xl">
            <div class="flex items-center space-x-2 truncate">
                <span class="material-icons text-red-500">picture_as_pdf</span>
                <span id="pdfTitle" class="font-bold text-xs uppercase tracking-wide">PDF Editor</span>
            </div>
            <button onclick="closePDF()" class="bg-red-600 px-4 py-2 rounded-lg text-[10px] font-black hover:bg-red-500 shadow transition-colors flex items-center"><span class="material-icons text-sm mr-1">close</span>TUTUP</button>
        </div>
        <div id="adobe-dc-view" class="flex-1 w-full bg-gray-100"></div>
    </div>

    <nav class="glass-nav text-white p-4 sticky top-0 z-50 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center max-w-2xl">
            <div class="flex items-center space-x-2">
                <div class="bg-gradient-to-br from-pink-500 to-orange-400 p-2 rounded-lg shadow-lg">
                    <span class="material-icons text-white">cloud_done</span>
                </div>
                <span class="font-black uppercase tracking-widest text-lg text-transparent bg-clip-text bg-gradient-to-r from-pink-200 to-indigo-200 drop-shadow-sm">eRPH Cloud</span>
            </div>
            <div class="flex space-x-2">
                <button id="groupBtn" onclick="showGroupSelection()" class="hidden bg-indigo-600/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-indigo-500 hover:scale-105 transition-transform">Kumpulan</button>
                <button id="switchRoleBtn" onclick="switchRoleView()" class="hidden bg-green-500/80 px-3 py-2 rounded-full text-xs font-bold text-white shadow-lg hover:bg-green-600 hover:scale-105 transition-transform">Mod Guru</button>
                <button id="logoutBtn" onclick="doLogout()" class="hidden bg-red-500/80 px-4 py-2 rounded-full text-xs font-bold shadow-lg hover:bg-red-600 hover:scale-105 transition-transform">Keluar</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-xl pb-20">
        <div id="loginSection" class="glass-panel p-8 rounded-3xl shadow-2xl mt-8 transform transition-all hover:shadow-[0_20px_50px_rgba(8,_112,_184,_0.7)]">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-black text-slate-800 mb-1">SELAMAT DATANG</h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Portal Pengurusan RPH Digital</p>
            </div>
            
            <div id="divLogin" class="text-center py-6">
                <p class="text-sm font-bold text-gray-600 mb-6">Sila log masuk menggunakan akaun Gmail atau Google Workspace (DELIMa) anda.</p>
                
                <div class="flex justify-center">
                    <div id="g_id_onload"
                         data-client_id="1069445355837-9so3o01qmcvbl9np66rjk0d81uo0g22o.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleCredentialResponse"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                </div>

                <button onclick="accessMaster()" class="w-full mt-10 text-[10px] text-gray-400 uppercase tracking-widest font-bold hover:text-indigo-500">Akses Master Admin</button>
            </div>
        </div>

        <div id="groupSelectionPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <h2 class="text-xl font-black text-indigo-900 mb-4 uppercase text-center tracking-wide">Pilih Kumpulan Anda</h2>
            <div id="groupListContainer" class="space-y-3">
                </div>
        </div>

        <div id="guruPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight" id="welcomeGuru">Nama</h2>
                    <p class="text-sm text-slate-500 mb-6 font-medium">Kumpulan: <span id="guruGroup" class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"></span></p>
                </div>
                <div id="myStats" class="bg-gradient-to-br from-yellow-100 to-orange-100 p-3 rounded-2xl text-center border border-yellow-200 shadow-sm">
                    <p class="text-[9px] font-black text-yellow-800 uppercase tracking-wide">Markah Terkumpul</p>
                    <div class="flex items-center justify-center space-x-1 mt-1">
                        <span class="material-icons text-yellow-600 text-sm">star</span>
                        <span id="myWeeklyStars" class="font-black text-2xl text-yellow-900">0</span>
                    </div>
                </div>
            </div>
            
            <div id="leaderboardArea" class="mb-6 bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-2xl border border-indigo-100 hidden">
                <h3 class="text-xs font-bold text-indigo-900 uppercase mb-2 flex items-center"><span class="material-icons text-sm mr-1">emoji_events</span> TOP 3 TERKUMPUL</h3>
                <div id="leaderboardList" class="space-y-2"></div>
            </div>

            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">1. Pilih Minggu</label>
            <div id="weekList" class="grid grid-cols-2 gap-3 mb-6 mt-2 p-3 bg-slate-50/50 rounded-2xl border border-slate-200"></div>
            
            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">2. Muat Naik Fail RPH</label>
            <div class="relative mt-2 mb-4">
                <input type="file" id="fileInp" multiple class="w-full p-4 border-2 border-dashed border-indigo-300 rounded-2xl bg-indigo-50/30 text-sm font-bold text-indigo-900 focus:bg-white transition-all">
                <div class="absolute top-0 right-0 p-4 pointer-events-none">
                    <span class="material-icons text-indigo-300">cloud_upload</span>
                </div>
            </div>
            <input type="hidden" id="selectedWeek">
            <button onclick="uploadRPH()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black shadow-lg hover:shadow-indigo-500/50 hover:scale-[1.02] transition-all">HANTAR RPH</button>

            <div id="teacherFilesArea" class="mt-8 pt-6 border-t border-slate-200 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-800 flex items-center uppercase tracking-wide"><span class="material-icons text-indigo-500 mr-1">history</span> Sejarah Hantaran:</h3>
                    <span id="lblTeacherWeek" class="bg-indigo-100 text-indigo-800 text-xs font-black px-3 py-1 rounded-full">-</span>
                </div>
                <div id="teacherFileList" class="space-y-3"></div>
            </div>
        </div>

        <div id="adminPanel" class="tab-content glass-panel p-6 rounded-3xl shadow-2xl mt-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="adminGroupName" class="text-xl font-black text-slate-800 uppercase">Nama Sekolah</h2>
                <button onclick="doAction('createWeek')" class="bg-indigo-600 text-white p-2 px-4 rounded-xl flex items-center shadow-lg hover:bg-indigo-500 font-bold text-xs"><span class="material-icons text-sm mr-1">add</span> Minggu</button>
            </div>
            
            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Senarai Folder Minggu</label>
            <p class="text-[10px] text-indigo-400 mb-2 italic">* Klik kanan pada folder untuk menu 'Padam' atau 'Namakan Semula'.</p>
            <div id="adminWeekList" class="grid grid-cols-2 gap-3 bg-slate-50/50 p-4 rounded-2xl mb-6 mt-2 border border-slate-200"></div>

            <div id="submissionArea" class="hidden mt-6">
                <h3 class="font-bold text-slate-800 border-b pb-2 mb-4 flex justify-between items-center">
                    <span id="adminBreadcrumb" class="uppercase tracking-wide text-sm">Folder Guru</span>
                    <span id="viewingWeek" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-[10px] font-black"></span>
                </h3>
                <div id="adminTeacherGrid" class="flex flex-col space-y-3"></div>
                <div id="adminTeacherFileView" class="hidden">
                    <button onclick="backToTeacherGrid()" class="mb-4 bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded-lg text-xs font-bold flex items-center transition-colors shadow"><span class="material-icons text-sm mr-1">arrow_back</span> KEMBALI</button>
                    <div id="adminFilesContainer" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <div id="masterPanel" class="tab-content bg-slate-900/95 backdrop-blur p-8 rounded-3xl text-white mt-6 shadow-2xl border border-slate-700">
            <h2 class="text-2xl font-black text-red-500 mb-6 flex items-center tracking-tighter"><span class="material-icons mr-2">admin_panel_settings</span> KAWALAN PUSAT</h2>
            
            <div class="mb-6 bg-gradient-to-r from-slate-800 to-slate-900 p-4 rounded-xl border border-slate-600 shadow-lg">
                <h3 class="text-[10px] font-black text-green-400 uppercase tracking-widest mb-1">INFO LESEN APLIKASI</h3>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-gray-400">Tarikh Mula: <span id="licStart" class="text-white font-mono">-</span></span>
                    <span class="text-gray-400">Tarikh Tamat: <span id="licEnd" class="text-yellow-400 font-mono font-bold">-</span></span>
                </div>
            </div>

            <div class="mb-10 bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-inner">
                <h3 class="text-xs font-black text-blue-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Senarai Pengguna (Email)</h3>
                <div id="masterUserList" class="space-y-2 h-64 overflow-auto custom-scrollbar">
                    <p class="text-xs text-slate-500 animate-pulse">Memuatkan data pengguna...</p>
                </div>
            </div>

            <div class="mb-10">
                <h3 class="text-xs font-black text-slate-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Kumpulan Berdaftar</h3>
                <div id="masterGroupList" class="space-y-3">
                    <p class="text-xs text-slate-500 animate-pulse">Memuatkan data dari pangkalan data...</p>
                </div>
            </div>
            
            <div class="mb-10">
                 <h3 class="text-xs font-black text-yellow-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-widest">Global Leaderboard</h3>
                 <div id="masterStatsList" class="space-y-2 bg-slate-800 p-4 rounded-xl h-48 overflow-auto border border-slate-700">
                     <p class="text-xs text-slate-500 italic">Sila tunggu...</p>
                 </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-inner">
                <h3 id="masterFormTitle" class="text-sm font-bold text-green-400 mb-4 flex items-center uppercase tracking-wide"><span class="material-icons text-sm mr-1">add_circle</span> Daftar Kumpulan Baharu</h3>
                <div class="space-y-4 text-black">
                    <input type="hidden" id="mGMode" value="new">
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Nama Kumpulan (Unik)</label>
                        <input type="text" id="mGName" placeholder="Contoh: PENTADBIR" class="w-full p-4 rounded-xl mt-1 bg-slate-100 focus:bg-white transition-all font-bold">
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Email Admin Kumpulan</label>
                        <input type="text" id="mGAdmin" placeholder="admin@gmail.com" class="w-full p-4 rounded-xl mt-1 bg-slate-100 focus:bg-white transition-all font-bold">
                    </div>
                    
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase ml-1">Senarai Email Ahli (Guru)</label>
                        <textarea id="mGMembers" placeholder="pisahkan, dengan, koma. Contoh: guru1@gmail.com, guru2@moe-dl.edu.my" class="w-full p-4 rounded-xl h-24 mt-1 bg-slate-100 focus:bg-white transition-all leading-relaxed font-mono text-xs"></textarea>
                    </div>

                    <div class="flex space-x-2 pt-2">
                        <button id="btnSaveGroup" onclick="submitMasterGroup()" class="flex-1 bg-red-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-red-500 transition-colors">DAFTAR KUMPULAN</button>
                        <button id="btnCancelEdit" onclick="resetMasterForm()" class="hidden bg-slate-500 text-white px-6 py-4 rounded-xl font-bold shadow-lg hover:bg-slate-400 transition-colors">BATAL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzMgkTKVaAZIUYL_ILzcD9kz-nhTC9PtcMIS_FU9g8ym8rfSDxHZdYWLitKN0-bVuPbJg/exec";
        
        let user = { email: "", groups: [], activeGroup: "", activeRole: "", name: "" };
        let currentAdminData = [];
        let viewingTeacherName = null;
        let targetContextWeek = "";

        // --- SESSION RESTORE LOGIC ---
        try {
            const savedSess = localStorage.getItem('erph_session_google');
            if(savedSess) {
                const s = JSON.parse(savedSess);
                if(s && s.email) {
                    user = s;
                    document.addEventListener("DOMContentLoaded", () => {
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('logoutBtn').classList.remove('hidden');
                        showGroupSelection();
                    });
                }
            }
        } catch(e) { console.log("No session"); }

        function showLoading(s, txt="SEDANG MEMPROSES...") { 
            document.getElementById('loading').style.display = s ? 'flex' : 'none'; 
            document.getElementById('loadText').innerText = txt;
        }

        function doLogout() {
            localStorage.removeItem('erph_session_google');
            location.reload();
        }

        async function runAPI(actionName, payloadData) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: actionName, data: payloadData }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    redirect: 'follow'
                });
                return await res.json();
            } catch (err) { Swal.fire("Ralat Rangkaian", "Sila semak internet anda.", "error"); return null; }
        }

        // FUNGSI GOOGLE SIGN IN RESPONSE
        async function handleCredentialResponse(response) {
            showLoading(true, "MENGESAHKAN AKAUN GMAIL...");
            const res = await runAPI('loginGoogle', { token: response.credential });
            showLoading(false);
            
            if(!res) return;
            if (res.error) return Swal.fire("Ralat Server", res.error, "error");
            if (!res.found) return Swal.fire("GAGAL", res.message, "error");

            Swal.fire({ icon: 'success', title: `Selamat Datang, ${res.name}!`, timer: 2000, showConfirmButton: false });
            
            user = {
                name: res.name,
                email: res.email, // Email acts as the IC now
                groups: res.groups || []
            };
            
            localStorage.setItem('erph_session_google', JSON.stringify(user));

            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('logoutBtn').classList.remove('hidden');
            showGroupSelection();
        }

        async function doAction(action) {
            try {
                if (action === 'getWeeksGuru') {
                    const weeks = await runAPI('getWeeks', { group: user.activeGroup, role: 'GURU', userName: user.name });
                    if(!weeks) return;
                    const cont = document.getElementById('weekList');
                    cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-red-500 col-span-2'>Tiada folder.</p>";
                    
                    weeks.forEach(wObj => {
                        let w = typeof wObj === 'string' ? wObj : wObj.name;
                        let status = wObj.status || 'DEFAULT';
                        let colorClass = "bg-white text-gray-700 border-gray-200";
                        if(status === 'RED') colorClass = "bg-red-50 text-red-900 border-red-200"; 
                        else if(status === 'YELLOW') colorClass = "bg-yellow-50 text-yellow-900 border-yellow-200"; 
                        else if(status === 'BLUE') colorClass = "bg-blue-50 text-blue-900 border-blue-200"; 

                        const btn = document.createElement('div');
                        btn.className = `p-4 border-2 rounded-xl text-center text-sm font-bold cursor-pointer card-week ${colorClass}`;
                        btn.innerText = w;
                        btn.onclick = () => {
                            document.getElementById('selectedWeek').value = w;
                            Array.from(cont.children).forEach(c => c.classList.remove('selected'));
                            btn.classList.add('selected');
                            fetchTeacherFiles(w);
                            fetchLeaderboard(w);
                        };
                        cont.appendChild(btn);
                    });
                } 
                else if (action === 'getWeeksAdmin') {
                    const weeks = await runAPI('getWeeks', { group: user.activeGroup, role: 'ADMIN' });
                    if(!weeks) return;
                    const cont = document.getElementById('adminWeekList');
                    cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-red-500 col-span-2'>Tiada folder.</p>";
                    
                    weeks.forEach(wObj => {
                        let w = typeof wObj === 'string' ? wObj : wObj.name;
                        let status = wObj.status || 'DEFAULT';
                        let colorClass = "bg-indigo-50 text-indigo-900 border-indigo-200 hover:bg-indigo-100";
                        if(status === 'RED') colorClass = "bg-red-50 text-red-900 border-red-200 hover:bg-red-100";
                        else if(status === 'YELLOW') colorClass = "bg-yellow-50 text-yellow-900 border-yellow-200 hover:bg-yellow-100";

                        const btn = document.createElement('div');
                        btn.className = `p-4 border-2 rounded-xl text-center text-sm font-bold cursor-pointer transition-colors ${colorClass}`;
                        btn.innerHTML = `<span class="material-icons block text-2xl mb-1">folder</span>${w}`;
                        
                        btn.onclick = () => { document.getElementById('viewingWeek').innerText = w; fetchAdminDashboard(w); };
                        btn.oncontextmenu = (e) => { e.preventDefault(); openContext(e, w); };
                        cont.appendChild(btn);
                    });
                } 
                else if (action === 'createWeek') {
                    const { value: n } = await Swal.fire({ title: "Nama Minggu (Cth: MINGGU 1):", input: "text", showCancelButton: true });
                    if(!n) return;
                    showLoading(true, "MENCIPTA FOLDER...");
                    const res = await runAPI('createWeek', { weekName: n, group: user.activeGroup });
                    showLoading(false);
                    if(res && res.status === 'success') { Swal.fire("Info", res.message, "success"); doAction('getWeeksAdmin'); }
                }
            } catch (error) { showLoading(false); }
        }

        // --- CONTEXT MENU FUNCTIONS ---
        function openContext(e, wName) { targetContextWeek = wName; const menu = document.getElementById('folderCtxMenu'); menu.style.left = `${e.clientX}px`; menu.style.top = `${e.clientY}px`; menu.classList.remove('hidden'); menu.classList.add('scale-100'); }
        function closeContext() { const menu = document.getElementById('folderCtxMenu'); menu.classList.add('hidden'); menu.classList.remove('scale-100'); }
        function triggerRename() { closeContext(); renameWeekFolder(targetContextWeek); }
        function triggerDelete() { closeContext(); deleteWeekFolder(targetContextWeek); }

        function showGroupSelection() {
            document.getElementById('guruPanel').classList.remove('active-tab');
            document.getElementById('adminPanel').classList.remove('active-tab');
            document.getElementById('groupSelectionPanel').classList.add('active-tab');
            document.getElementById('groupBtn').classList.add('hidden');
            document.getElementById('switchRoleBtn').classList.add('hidden');
            
            const list = document.getElementById('groupListContainer');
            list.innerHTML = "";
            if(user.groups.length === 0) {
                list.innerHTML = "<p class='text-center text-red-500 font-bold'>Anda belum didaftarkan dalam mana-mana kumpulan oleh Admin.</p>";
                return;
            }
            
            user.groups.forEach(g => {
                let roleLabel = g.role === 'ADMIN_KUMPULAN' ? 'ADMIN' : 'GURU';
                let color = g.role === 'ADMIN_KUMPULAN' ? 'bg-indigo-50 text-indigo-900 border-indigo-200' : 'bg-green-50 text-green-800 border-green-200';
                list.innerHTML += `
                    <div onclick="selectGroup('${g.group}', '${g.role}')" class="${color} border-2 p-4 rounded-xl cursor-pointer hover:shadow-lg transition-all flex justify-between items-center">
                        <span class="font-black">${g.group}</span>
                        <span class="text-[10px] font-bold bg-white px-2 py-1 rounded shadow-sm">${roleLabel}</span>
                    </div>`;
            });
        }

        function selectGroup(gName, role) {
            user.activeGroup = gName;
            user.activeRole = role;
            document.getElementById('groupSelectionPanel').classList.remove('active-tab');
            document.getElementById('groupBtn').classList.remove('hidden');
            
            if (role === 'ADMIN_KUMPULAN') {
                document.getElementById('switchRoleBtn').classList.remove('hidden');
                document.getElementById('switchRoleBtn').innerText = "Mod Guru";
                document.getElementById('switchRoleBtn').onclick = () => switchRoleView('GURU');
                openAdminPanel();
            } else {
                document.getElementById('switchRoleBtn').classList.add('hidden');
                openGuruPanel();
            }
        }

        function switchRoleView(forceRole) {
            user.activeRole = forceRole;
            if(forceRole === 'GURU') {
                document.getElementById('switchRoleBtn').innerText = "Mod Admin";
                document.getElementById('switchRoleBtn').onclick = () => switchRoleView('ADMIN_KUMPULAN');
                openGuruPanel();
            } else {
                document.getElementById('switchRoleBtn').innerText = "Mod Guru";
                document.getElementById('switchRoleBtn').onclick = () => switchRoleView('GURU');
                openAdminPanel();
            }
        }

        function openGuruPanel() {
            document.getElementById('adminPanel').classList.remove('active-tab');
            document.getElementById('guruPanel').classList.add('active-tab');
            document.getElementById('welcomeGuru').innerText = user.name;
            document.getElementById('guruGroup').innerText = user.activeGroup;
            document.getElementById('teacherFilesArea').classList.add('hidden');
            document.getElementById('leaderboardArea').classList.add('hidden');
            document.getElementById('myWeeklyStars').innerText = "0";
            document.getElementById('selectedWeek').value = "";
            doAction('getWeeksGuru');
        }

        function openAdminPanel() {
            document.getElementById('guruPanel').classList.remove('active-tab');
            document.getElementById('adminPanel').classList.add('active-tab');
            document.getElementById('adminGroupName').innerText = user.activeGroup;
            document.getElementById('submissionArea').classList.add('hidden');
            doAction('getWeeksAdmin');
        }

        async function uploadRPH() {
            const wk = document.getElementById('selectedWeek').value;
            const fileInput = document.getElementById('fileInp');
            if(!wk) return Swal.fire("Ralat", "Sila pilih minggu!", "warning");
            if(!fileInput.files.length) return Swal.fire("Ralat", "Sila pilih fail (PDF/Word/Excel)!", "warning");
            
            showLoading(true, "SEDANG MEMUAT NAIK...");
            let success = 0;
            for(let i=0; i<fileInput.files.length; i++) {
                try { await uploadSingleFile(fileInput.files[i], wk); success++; } catch(e) { Swal.fire("Ralat", e, "error"); }
            }
            showLoading(false);
            if(success > 0) {
                fileInput.value = "";
                fetchTeacherFiles(wk);
                doAction('getWeeksGuru');
            }
        }

        function uploadSingleFile(f, wk) {
            return new Promise((resolve, reject) => {
                if(f.size > 10 * 1024 * 1024) return reject("Fail melebihi 10MB");
                const reader = new FileReader();
                reader.onload = function(e) {
                    const payload = { data: e.target.result.split(',')[1], mimeType: f.type, fileName: f.name, week: wk, group: user.activeGroup, userName: user.name };
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", API_URL);
                    xhr.setRequestHeader("Content-Type", "text/plain;charset=utf-8");
                    xhr.onload = () => { if (xhr.status === 200) resolve(); else reject(`HTTP Error ${xhr.status}`); };
                    xhr.send(JSON.stringify({ action: 'upload', data: payload }));
                };
                reader.readAsDataURL(f);
            });
        }

        async function fetchTeacherFiles(weekName) {
            document.getElementById('teacherFilesArea').classList.remove('hidden');
            document.getElementById('lblTeacherWeek').innerText = weekName;
            const cont = document.getElementById('teacherFileList');
            cont.innerHTML = "<p class='text-xs text-gray-400 italic'>Menyemak fail anda...</p>";
            const res = await runAPI('getTeacherFiles', { group: user.activeGroup, week: weekName, userName: user.name });
            if(!res || res.status === "error") return cont.innerHTML = `<p class='text-xs text-red-500'>Tiada folder.</p>`;
            
            document.getElementById('myWeeklyStars').innerText = res.cumulativeScore || 0;
            cont.innerHTML = "";
            if(res.files.length === 0) return cont.innerHTML = "<p class='text-xs text-gray-400'>Belum ada hantaran.</p>";
            
            res.files.forEach(f => {
                let cleanName = f.name.replace(`[${user.name}] `, '');
                let r = f.rating || 0;
                let statusBadge = r > 0 || f.comment ? `<span class="bg-green-100 text-green-700 text-[10px] font-black px-2 py-0.5 rounded-full uppercase">Disemak</span>` : `<span class="bg-yellow-100 text-yellow-700 text-[10px] font-black px-2 py-0.5 rounded-full uppercase">Pending</span>`;
                let starHtml = "";
                for(let i=1; i<=5; i++) starHtml += `<span class="material-icons text-sm ${i <= r ? 'text-yellow-500' : 'text-gray-300'}">star</span>`;
                let verifierText = f.verifier ? `<p class="text-[9px] text-gray-500 italic mt-1">Oleh: ${f.verifier}</p>` : "";
                
                cont.innerHTML += `
                <div class="p-3 rounded-xl border bg-white border-gray-100 shadow-sm">
                    <div class="flex justify-between items-center">
                        <div class="flex-1 overflow-hidden">
                            <p class="text-xs font-bold text-gray-700 truncate">${cleanName}</p>
                            <div class="mt-1 flex items-center">${statusBadge}</div>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="window.open('${f.url}', '_blank')" class="bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg text-[10px] font-bold">LIHAT</button>
                            <button onclick="deleteRPHFile('${f.id}', '${cleanName}')" class="bg-red-50 text-red-700 px-2 py-2 rounded-lg"><span class="material-icons text-sm">delete</span></button>
                        </div>
                    </div>
                    <div class="mt-2">${starHtml}</div>
                    ${f.comment ? `<p class="text-xs text-gray-600 bg-gray-50 p-2 rounded-lg mt-2 font-medium italic">"${f.comment}"</p>` : ""}
                    ${f.aiRating ? `<p class="text-[10px] text-purple-600 font-bold mt-1">AI Suggestion: ${f.aiRating} Bintang</p>` : ""}
                    ${verifierText}
                </div>`;
            });
        }

        async function fetchLeaderboard(weekName) {
            document.getElementById('leaderboardArea').classList.add('hidden');
            const res = await runAPI('getLeaderboard', { group: user.activeGroup, week: weekName });
            if(res && res.data && res.data.length > 0) {
                const list = document.getElementById('leaderboardList');
                list.innerHTML = "";
                res.data.forEach((t, idx) => {
                    let medal = idx===0 ? "ðŸ¥‡" : (idx===1 ? "ðŸ¥ˆ" : "ðŸ¥‰");
                    list.innerHTML += `<div class="flex justify-between text-xs font-bold p-2 bg-white rounded-lg"><span class="truncate">${medal} ${t.name}</span><span class="text-indigo-600">${t.score}</span></div>`;
                });
                document.getElementById('leaderboardArea').classList.remove('hidden');
            }
        }

        async function deleteRPHFile(fid, fname) {
            const r = await Swal.fire({ title: 'Padam RPH?', text: fname, icon: 'warning', showCancelButton: true });
            if(!r.isConfirmed) return;
            showLoading(true, "MEMADAM FAIL...");
            const res = await runAPI('deleteFile', { fileId: fid, group: user.activeGroup, week: document.getElementById('selectedWeek').value || document.getElementById('viewingWeek').innerText });
            showLoading(false);
            if(res && res.status === 'success') {
                if(user.activeRole === 'GURU') fetchTeacherFiles(document.getElementById('selectedWeek').value);
                else { fetchAdminDashboard(document.getElementById('viewingWeek').innerText); backToTeacherGrid(); }
            }
        }

        async function fetchAdminDashboard(weekName) {
            document.getElementById('submissionArea').classList.remove('hidden');
            document.getElementById('adminTeacherGrid').classList.remove('hidden');
            document.getElementById('adminTeacherFileView').classList.add('hidden');
            
            const cont = document.getElementById('adminTeacherGrid');
            cont.innerHTML = "<p class='text-xs text-gray-400 italic text-center'>Memuatkan data guru...</p>";
            
            const res = await runAPI('getAdminSubmissionsData', { group: user.activeGroup, week: weekName });
            if(!res || res.status === "error") return cont.innerHTML = `<p class='text-xs text-red-500'>Ralat muat fail.</p>`;
            
            currentAdminData = res.data;
            cont.innerHTML = "";
            res.data.forEach((teacher, index) => {
                let isAllGraded = teacher.files.length > 0 && teacher.files.every(f => (f.rating > 0) || (f.comment && f.comment.trim() !== ""));
                let isMissing = teacher.files.length === 0;
                let bgClass = isMissing ? "bg-red-50 border-red-200 text-red-900" : (isAllGraded ? "bg-green-50 border-green-200 text-green-900" : "bg-yellow-50 border-yellow-200 text-yellow-900");
                let iconClass = isMissing ? "text-red-300" : (isAllGraded ? "text-green-500" : "text-yellow-500");
                let status = isMissing ? "BELUM HANTAR" : (isAllGraded ? "SELESAI SEMAK" : "PENDING SEMAK");
                
                cont.innerHTML += `
                <div onclick="openTeacherFiles(${index})" class="${bgClass} border p-4 rounded-xl flex items-center justify-between cursor-pointer shadow-sm hover:shadow-md transition-all">
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <span class="material-icons ${iconClass} text-3xl">folder</span>
                        <div class="flex flex-col min-w-0">
                            <h4 class="font-bold text-sm truncate">${teacher.teacherName}</h4>
                            <span class="text-[9px] font-bold opacity-80 uppercase tracking-wide">${status}</span>
                        </div>
                    </div>
                    <div class="shrink-0 pl-2">
                        <span class="text-[10px] font-bold bg-white/50 px-3 py-1 rounded-full border border-black/5">${teacher.files.length} Fail</span>
                    </div>
                </div>`;
            });
            if(viewingTeacherName) {
                const idx = currentAdminData.findIndex(t => t.teacherName === viewingTeacherName);
                if(idx >= 0) openTeacherFiles(idx); else backToTeacherGrid();
            }
        }

        function openTeacherFiles(idx) {
            const teacher = currentAdminData[idx];
            if(!teacher) return;
            viewingTeacherName = teacher.teacherName;
            document.getElementById('adminTeacherGrid').classList.add('hidden');
            document.getElementById('adminTeacherFileView').classList.remove('hidden');
            document.getElementById('adminBreadcrumb').innerText = "RPH: " + teacher.teacherName;
            
            const cont = document.getElementById('adminFilesContainer');
            cont.innerHTML = "";
            if(teacher.files.length === 0) return cont.innerHTML = "<p class='text-center text-gray-400 italic py-10'>Tiada fail dimuat naik.</p>";
            
            teacher.files.forEach(f => {
                let cleanName = f.name.replace(`[${teacher.teacherName}] `, '');
                let currentRating = f.rating || 0;
                let aiBadge = f.aiRating ? `<span class="float-right bg-purple-100 text-purple-700 text-[9px] font-bold px-1 rounded">AI: ${f.aiRating}â˜…</span>` : "";
                let stars = "";
                for(let i=1; i<=5; i++) {
                    stars += `<span class="material-icons text-xl ${i <= currentRating ? "text-yellow-500" : "text-gray-300"} star-icon" onclick="rateFile('${f.id}', ${i}, '${teacher.teacherName}', '${cleanName}')">star</span>`;
                }
                
                cont.innerHTML += `
                <div class="bg-white p-4 rounded-xl border shadow-sm">
                    <p class="font-bold text-sm text-indigo-900 truncate mb-2">${cleanName} ${aiBadge}</p>
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 mb-3">
                        <div class="flex space-x-1">${stars}</div>
                        <div class="text-[10px] font-bold bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${currentRating}/5</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="commentFile('${f.id}', '${f.comment||''}', '${teacher.teacherName}', '${cleanName}')" class="flex-1 bg-slate-800 text-white py-2 rounded-lg text-xs font-bold hover:bg-slate-700"><span class="material-icons text-[12px] mr-1">chat</span>ULASAN</button>
                        <button onclick="window.open('${f.url}', '_blank')" class="bg-indigo-100 text-indigo-800 px-3 py-2 rounded-lg"><span class="material-icons text-sm">visibility</span></button>
                        <button onclick="deleteRPHFile('${f.id}', '${cleanName}')" class="bg-red-50 text-red-600 px-3 py-2 rounded-lg"><span class="material-icons text-sm">delete</span></button>
                    </div>
                </div>`;
            });
        }

        function backToTeacherGrid() {
            viewingTeacherName = null;
            document.getElementById('adminTeacherGrid').classList.remove('hidden');
            document.getElementById('adminTeacherFileView').classList.add('hidden');
            document.getElementById('adminBreadcrumb').innerText = "Folder Guru";
        }

        async function rateFile(fid, rating, tName, fName) {
            showLoading(true, "MENYIMPAN MARKAH...");
            const wk = document.getElementById('viewingWeek').innerText;
            const res = await runAPI('rateStar', { fileId: fid, rating: rating, group: user.activeGroup, week: wk, teacherName: tName, fileName: fName, adminName: user.name });
            showLoading(false);
            if(res && res.status === "success") { fetchAdminDashboard(wk); doAction('getWeeksAdmin'); }
        }

        async function commentFile(fid, oldComment, tName, fName) {
            const { value: c } = await Swal.fire({ title: "Ulasan Admin:", input: "text", inputValue: oldComment, showCancelButton: true });
            if(c === null || c === undefined) return;
            showLoading(true, "MENYIMPAN ULASAN & ANALISIS AI...");
            const wk = document.getElementById('viewingWeek').innerText;
            const res = await runAPI('saveComment', { fileId: fid, comment: c, group: user.activeGroup, week: wk, teacherName: tName, fileName: fName });
            showLoading(false);
            if(res && res.status === "success") fetchAdminDashboard(wk);
        }

        async function accessMaster() {
            const { value: code } = await Swal.fire({ title: "_o0o_(0..o)_o0o_", input: "password" });
            if(code === "101010") {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('masterPanel').classList.add('active-tab');
                document.getElementById('logoutBtn').classList.remove('hidden');
                fetchMasterGroups();
                fetchGlobalStats();
                fetchMasterUsers();
            }
        }

        async function fetchMasterGroups() {
            const cont = document.getElementById('masterGroupList');
            cont.innerHTML = "<p class='text-xs text-gray-500'>Menarik rekod...</p>";
            const res = await runAPI('getAllGroups', {});
            if (!res || res.status === "error") return cont.innerHTML = "<p class='text-xs text-red-500'>Gagal.</p>";
            cont.innerHTML = "";
            res.data.forEach(g => {
                cont.innerHTML += `
                <div class="bg-slate-700 p-4 rounded-xl border border-slate-600 mb-2">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-black text-indigo-300 text-sm uppercase">${g.groupName}</h4>
                        <div class="flex space-x-1">
                            <button onclick="editMasterGroup('${g.groupName}', '${g.adminEmail}', '${g.members}')" class="bg-blue-600 text-white p-1 rounded hover:bg-blue-500" title="Edit"><span class="material-icons text-[14px]">edit</span></button>
                            <button onclick="deleteMasterGroup('${g.groupName}')" class="bg-red-600 text-white p-1 rounded hover:bg-red-500" title="Padam"><span class="material-icons text-[14px]">delete</span></button>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400">Admin Email: <span class="text-white">${g.adminEmail}</span></p>
                    <p class="text-[10px] text-gray-400 mt-1 line-clamp-2" title="${g.members}">Ahli: <span class="text-white">${g.members}</span></p>
                </div>`;
            });
        }

        async function fetchGlobalStats() {
            const res = await runAPI('getGlobalStats', {});
            if(res && res.data) {
                const list = document.getElementById('masterStatsList');
                list.innerHTML = "";
                res.data.forEach((t, i) => { list.innerHTML += `<div class="flex justify-between text-xs p-2 border-b border-slate-600"><span class="text-white">${i+1}. ${t.name} <span class="text-[9px] text-gray-400">(${t.group})</span></span><span class="text-yellow-400 font-bold">${t.total}</span></div>`; });
            }
        }

        async function fetchMasterUsers() {
            const cont = document.getElementById('masterUserList');
            const res = await runAPI('getAllUsers', {});
            if(res && res.status === 'success') {
                cont.innerHTML = "";
                res.data.forEach(u => {
                    let gColor = u.group === 'PENDING' ? 'text-red-400' : 'text-green-400';
                    cont.innerHTML += `
                    <div class="flex justify-between items-center text-xs bg-slate-700 p-3 rounded-lg mb-2 border border-slate-600">
                        <div class="truncate mr-2 flex-1">
                            <p class="font-bold text-white text-sm mb-1">${u.name}</p>
                            <p class="text-[10px] text-gray-400">Email: <span class="text-white">${u.email}</span></p>
                            <p class="text-[10px] text-gray-400 mt-1">Group: <span class="${gColor} font-bold tracking-wide">${u.group}</span></p>
                        </div>
                        <button onclick="deleteUser('${u.email}', '${u.name}')" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-500"><span class="material-icons text-[14px]">delete_forever</span></button>
                    </div>`;
                });
            }
        }

        async function deleteUser(email, name) {
            const r = await Swal.fire({ title: 'Padam Pengguna?', text: name + " ("+email+")", icon: 'warning', showCancelButton: true });
            if(!r.isConfirmed) return;
            showLoading(true, "MEMADAM...");
            const res = await runAPI('deleteUser', { email: email });
            showLoading(false);
            if(res && res.status === 'success') fetchMasterUsers();
        }

        function editMasterGroup(name, admin, members) {
            document.getElementById('mGMode').value = "edit";
            document.getElementById('mGName').value = name;
            document.getElementById('mGName').readOnly = true;
            document.getElementById('mGName').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('mGAdmin').value = admin;
            document.getElementById('mGMembers').value = members;
            document.getElementById('masterFormTitle').innerHTML = `<span class="material-icons text-sm mr-1">edit</span> KEMASKINI KUMPULAN`;
            document.getElementById('masterFormTitle').className = "text-sm font-bold text-blue-400 mb-4 flex items-center";
            document.getElementById('btnSaveGroup').innerText = "SIMPAN KEMASKINI";
            document.getElementById('btnSaveGroup').className = "flex-1 bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-blue-500 transition-colors";
            document.getElementById('btnCancelEdit').classList.remove('hidden');
        }

        function resetMasterForm() {
            document.getElementById('mGMode').value = "new";
            document.getElementById('mGName').value = "";
            document.getElementById('mGName').readOnly = false;
            document.getElementById('mGName').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('mGAdmin').value = "";
            document.getElementById('mGMembers').value = "";
            document.getElementById('masterFormTitle').innerHTML = `<span class="material-icons text-sm mr-1">add_circle</span> DAFTAR KUMPULAN BAHARU`;
            document.getElementById('masterFormTitle').className = "text-sm font-bold text-green-400 mb-4 flex items-center";
            document.getElementById('btnSaveGroup').innerText = "DAFTAR KUMPULAN";
            document.getElementById('btnSaveGroup').className = "flex-1 bg-red-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-red-500 transition-colors";
            document.getElementById('btnCancelEdit').classList.add('hidden');
        }

        async function submitMasterGroup() {
            const mode = document.getElementById('mGMode').value;
            const name = document.getElementById('mGName').value.trim();
            const admin = document.getElementById('mGAdmin').value.trim().toLowerCase();
            const members = document.getElementById('mGMembers').value.trim().toLowerCase();
            if (!name || !admin) return Swal.fire("Ralat", "Sila isi sekurang-kurangnya Nama Kumpulan dan Email Admin.", "warning");
            
            showLoading(true, mode==="new" ? "MENDAFTAR..." : "MENGEMASKINI...");
            const res = await runAPI(mode==="new" ? 'saveGroup' : 'updateGroup', { groupName: name, adminEmail: admin, memberEmailsStr: members });
            showLoading(false);
            if (res) {
                Swal.fire("Berjaya", res.message || res, "success");
                resetMasterForm(); fetchMasterGroups(); fetchMasterUsers();
            }
        }

        async function deleteMasterGroup(gName) {
            const r = await Swal.fire({ title: 'Padam Kumpulan?', text: gName, icon: 'warning', showCancelButton: true });
            if(r.isConfirmed) {
                showLoading(true, "MEMADAM...");
                const res = await runAPI('deleteGroup', { groupName: gName });
                showLoading(false);
                if(res) { fetchMasterGroups(); fetchMasterUsers(); }
            }
        }

        async function deleteWeekFolder(wName) {
             const r = await Swal.fire({ title: 'Padam Folder Minggu?', text: "Semua fail akan dipadam.", icon: 'warning', showCancelButton: true });
             if(r.isConfirmed) {
                 showLoading(true, "MEMADAM...");
                 await runAPI('deleteWeek', { weekName: wName, group: user.activeGroup });
                 showLoading(false); doAction('getWeeksAdmin');
             }
        }
        async function renameWeekFolder(oldName) {
             const { value: newN } = await Swal.fire({ title: "Namakan Semula", input: 'text', inputValue: oldName, showCancelButton: true });
             if(newN && newN !== oldName) {
                 showLoading(true, "MENGEMASKINI...");
                 await runAPI('renameWeek', { oldName: oldName, newName: newN, group: user.activeGroup });
                 showLoading(false); doAction('getWeeksAdmin');
             }
        }
    </script>
</body>
</html>

