<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eRPH Cloud 551</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .card-week.selected { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
        #reviewModal { z-index: 1000; }
        canvas { cursor: crosshair; touch-action: none; background: transparent; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-indigo-600 mb-2"></div>
            <p class="font-bold text-indigo-900 tracking-wider" id="loadText">SEDANG MEMPROSES...</p>
        </div>
    </div>

    <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-95 hidden flex-col">
        <div class="flex justify-between items-center text-white p-4 bg-gray-900 shadow-md">
            <div class="flex items-center space-x-3">
                <span class="material-icons text-green-400">draw</span>
                <div>
                    <h3 class="font-bold text-sm">Mod Semakan Admin</h3>
                    <p class="text-[10px] text-gray-400" id="reviewFileName">-</p>
                </div>
            </div>
            <button onclick="closeReview()" class="bg-red-600 px-3 py-1 rounded font-bold text-xs hover:bg-red-700">TUTUP</button>
        </div>
        <div class="flex-1 relative overflow-auto flex justify-center items-start bg-gray-800 p-2" id="canvasContainer">
            <div class="relative bg-white shadow-2xl" id="reviewWrapper" style="min-width: 300px; min-height: 400px;">
                <img id="reviewImage" class="max-w-full h-auto block" alt="Sila tunggu imej dimuat turun..." crossorigin="anonymous" />
                <canvas id="reviewCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
            </div>
        </div>
        <div class="bg-gray-900 p-4 flex justify-between items-center gap-2">
            <div class="flex items-center space-x-2 bg-gray-800 p-2 rounded-lg">
                <input type="color" id="penColor" value="#ff0000" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                <button onclick="clearCanvas()" class="text-yellow-400 text-xs font-bold px-2 flex flex-col items-center"><span class="material-icons text-sm">delete</span>Padam</button>
            </div>
            <button onclick="saveSemakan()" class="bg-green-600 text-white px-6 py-3 rounded-xl text-sm font-black shadow-lg flex-1 hover:bg-green-500">SIMPAN SEMAKAN</button>
        </div>
    </div>

    <nav class="bg-indigo-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center max-w-2xl">
            <div class="flex items-center space-x-2">
                <span class="material-icons">cloud_done</span>
                <span class="font-bold uppercase tracking-widest text-lg">eRPH Cloud</span>
            </div>
            <button id="logoutBtn" onclick="location.reload()" class="hidden bg-red-500 px-4 py-2 rounded-full text-xs font-bold shadow-lg">Log Keluar</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-xl">
        <div id="loginSection" class="bg-white p-8 rounded-3xl shadow-xl mt-8">
            <div class="flex justify-around mb-8 border-b pb-2">
                <button onclick="toggleAuth('login')" id="btnTabLogin" class="font-bold text-indigo-900 border-b-2 border-indigo-900 pb-2">LOG MASUK</button>
                <button onclick="toggleAuth('signup')" id="btnTabSignup" class="font-bold text-gray-400 pb-2">DAFTAR</button>
            </div>
            <div id="divLogin">
                <input type="email" id="loginEmail" placeholder="Emel Google (Gmail)" class="w-full border p-3 rounded-xl mb-4 bg-gray-50">
                <input type="password" id="loginPass" placeholder="Kata Laluan" class="w-full border p-3 rounded-xl mb-6 bg-gray-50">
                <button onclick="doAction('login')" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">MASUK SISTEM</button>
                <button onclick="accessMaster()" class="w-full mt-6 text-[10px] text-gray-400 uppercase tracking-widest">Akses Master Admin</button>
            </div>
            <div id="divSignup" class="hidden space-y-4">
                <input type="text" id="regName" placeholder="Nama Penuh" class="w-full border p-3 rounded-xl bg-gray-50">
                <input type="email" id="regEmail" placeholder="Emel Gmail" class="w-full border p-3 rounded-xl bg-gray-50">
                <input type="password" id="regPass" placeholder="Cipta Kata Laluan" class="w-full border p-3 rounded-xl bg-gray-50">
                <button onclick="doAction('signup')" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-bold">HANTAR PENDAFTARAN</button>
            </div>
        </div>

        <div id="guruPanel" class="tab-content bg-white p-6 rounded-3xl shadow-xl mt-6">
            <h2 class="text-2xl font-black text-gray-800 uppercase" id="welcomeGuru">Nama</h2>
            <p class="text-sm text-gray-500 mb-6">Kumpulan: <span id="guruGroup" class="font-bold text-indigo-600"></span></p>
            
            <label class="text-xs font-bold text-gray-400 uppercase">1. Pilih Minggu</label>
            <div id="weekList" class="grid grid-cols-2 gap-2 mb-6 mt-1 p-2 bg-gray-50 rounded-2xl border"></div>
            
            <label class="text-xs font-bold text-gray-400 uppercase">2. Muat Naik Fail RPH</label>
            <input type="file" id="fileInp" class="w-full p-3 border-2 border-dashed border-indigo-200 rounded-2xl mb-4 bg-gray-50 mt-1">
            <input type="hidden" id="selectedWeek">
            <button onclick="uploadRPH()" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-black shadow-lg">HANTAR RPH</button>

            <div id="teacherFilesArea" class="mt-8 pt-6 border-t border-gray-100 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center"><span class="material-icons text-indigo-500 mr-1">history</span> Sejarah Hantaran:</h3>
                    <span id="lblTeacherWeek" class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded">-</span>
                </div>
                <div id="teacherFileList" class="space-y-3">
                    <p class="text-xs text-gray-400 italic">Sila pilih minggu di atas.</p>
                </div>
            </div>
        </div>

        <div id="adminPanel" class="tab-content bg-white p-6 rounded-3xl shadow-xl mt-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="adminGroupName" class="text-xl font-black text-gray-800 uppercase">Nama Sekolah</h2>
                <button onclick="doAction('createWeek')" class="bg-indigo-600 text-white p-2 rounded-xl flex items-center shadow-lg"><span class="material-icons text-sm mr-1">add</span> Minggu</button>
            </div>
            
            <label class="text-xs font-bold text-gray-400 uppercase">Senarai Folder Minggu</label>
            <div id="adminWeekList" class="grid grid-cols-2 gap-2 bg-indigo-50 p-4 rounded-2xl mb-6 mt-1"></div>

            <div id="submissionArea" class="hidden mt-6">
                <h3 class="font-bold text-gray-800 border-b pb-2 mb-4 flex justify-between items-center">
                    <span>Folder Guru</span>
                    <span id="viewingWeek" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded text-xs"></span>
                </h3>
                <div id="adminTeacherGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div id="masterPanel" class="tab-content bg-gray-900 p-8 rounded-3xl text-white mt-6">
            <h2 class="text-xl font-bold text-red-500 mb-6">KAWALAN PUSAT (MASTER)</h2>
            <div class="space-y-4 text-black">
                <input type="text" id="mGName" placeholder="Nama Sekolah" class="w-full p-4 rounded-xl">
                <input type="text" id="mGAdmin" placeholder="Emel Admin" class="w-full p-4 rounded-xl">
                <textarea id="mGMembers" placeholder="Emel Ahli (koma)" class="w-full p-4 rounded-xl h-24"></textarea>
                <button onclick="doAction('saveGroup')" class="w-full bg-red-600 text-white py-4 rounded-xl font-black">DAFTAR KUMPULAN</button>
            </div>
        </div>
    </div>

    <script>
        // MASUKKAN URL APP SCRIPT ANDA DI SINI
        const API_URL = "https://script.google.com/macros/s/AKfycbxtgwoi2rrM6pdT7pv5ULnnkNKaZ-n-CBIHEUBqMEZkjxMSrvYz6K5TG4WhiJl0WWUchQ/exec";
        
        let user = { email: "", group: "", name: "" };
        let canvas, ctx, isDrawing = false;
        let currentFileId = null;

        function showLoading(s, txt="SEDANG MEMPROSES...") { 
            document.getElementById('loading').style.display = s ? 'flex' : 'none'; 
            document.getElementById('loadText').innerText = txt;
        }

        function toggleAuth(mode) {
            document.getElementById('divLogin').classList.toggle('hidden', mode === 'signup');
            document.getElementById('divSignup').classList.toggle('hidden', mode === 'login');
            document.getElementById('btnTabLogin').className = mode === 'login' ? "font-bold text-indigo-900 border-b-2 border-indigo-900 pb-2" : "font-bold text-gray-400 pb-2";
            document.getElementById('btnTabSignup').className = mode === 'signup' ? "font-bold text-indigo-900 border-b-2 border-indigo-900 pb-2" : "font-bold text-gray-400 pb-2";
        }

        async function runAPI(actionName, payloadData) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: actionName, data: payloadData }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    redirect: 'follow'
                });
                return await res.json();
            } catch (err) { alert("Ralat Rangkaian. Sila semak internet anda."); return null; }
        }

        async function doAction(action) {
            try {
                if (action === 'login') {
                    const e = document.getElementById('loginEmail').value;
                    const p = document.getElementById('loginPass').value;
                    if(!e || !p) return alert("Sila isi emel dan kata laluan!");
                    
                    showLoading(true, "MENGESAHKAN AKAUN...");
                    const res = await runAPI('login', { email: e, password: p });
                    showLoading(false);
                    
                    if(!res) return;
                    if (res.error) return alert("Ralat Server: " + res.error);
                    if (!res.found) return alert("GAGAL: " + res.message);
                    
                    user = res;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    
                    if(res.role === "ADMIN_KUMPULAN") {
                        document.getElementById('adminPanel').classList.add('active-tab');
                        document.getElementById('adminGroupName').innerText = res.group;
                        doAction('getWeeksAdmin');
                    } else {
                        document.getElementById('guruPanel').classList.add('active-tab');
                        document.getElementById('welcomeGuru').innerText = res.name;
                        document.getElementById('guruGroup').innerText = res.group;
                        doAction('getWeeksGuru');
                    }
                } 
                else if (action === 'signup') {
                    const d = { name: document.getElementById('regName').value, email: document.getElementById('regEmail').value, pass: document.getElementById('regPass').value };
                    if(!d.name || !d.email || !d.pass) return alert("Lengkapkan maklumat.");
                    showLoading(true, "MENDAFTAR...");
                    const res = await runAPI('signup', d);
                    showLoading(false); if(res) { alert(res); toggleAuth('login'); }
                }
                else if (action === 'getWeeksGuru') {
                    const weeks = await runAPI('getWeeks', { group: user.group });
                    if(!weeks) return;
                    const cont = document.getElementById('weekList');
                    cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-red-500 col-span-2'>Tiada folder.</p>";
                    weeks.forEach(w => {
                        const btn = document.createElement('div');
                        btn.className = "p-3 border-2 rounded-xl text-center text-sm font-bold cursor-pointer bg-white text-gray-700 card-week";
                        btn.innerText = w;
                        btn.onclick = () => { 
                            document.getElementById('selectedWeek').value = w; 
                            Array.from(cont.children).forEach(c => c.classList.remove('selected')); 
                            btn.classList.add('selected'); 
                            fetchTeacherFiles(w); // Tarik fail guru bila klik minggu
                        };
                        cont.appendChild(btn);
                    });
                }
                else if (action === 'getWeeksAdmin') {
                    const weeks = await runAPI('getWeeks', { group: user.group });
                    if(!weeks) return;
                    const cont = document.getElementById('adminWeekList');
                    cont.innerHTML = weeks.length ? "" : "<p class='text-xs text-gray-500 col-span-2'>Sila cipta minggu.</p>";
                    weeks.forEach(w => {
                        const btn = document.createElement('div');
                        btn.className = "p-3 border rounded-xl font-bold text-indigo-900 bg-white shadow-sm text-sm text-center cursor-pointer hover:bg-indigo-100 hover:shadow";
                        btn.innerText = w;
                        btn.onclick = () => { fetchAdminDashboard(w); }; 
                        cont.appendChild(btn);
                    });
                }
                else if (action === 'createWeek') {
                    const n = prompt("Nama Minggu (Cth: MINGGU 1):");
                    if(!n) return;
                    showLoading(true, "MENCIPTA FOLDER...");
                    const res = await runAPI('createWeek', { weekName: n, group: user.group });
                    showLoading(false); 
                    if(res) { alert(res.message); if(res.status === 'success') doAction('getWeeksAdmin'); }
                }
            } catch (error) { showLoading(false); }
        }

        // --- GURU: HANTAR DAN LIHAT RPH ---

        function uploadRPH() {
            const wk = document.getElementById('selectedWeek').value;
            const f = document.getElementById('fileInp').files[0];
            if(!wk || !f) return alert("Sila pilih MINGGU dan FAIL RPH terlebih dahulu.");
            
            showLoading(true, "MUAT NAIK FAIL...");
            const reader = new FileReader();
            reader.onload = async function(e) {
                // Hantar nama cikgu sekali untuk Auto Rename file
                const payload = { data: e.target.result.split(',')[1], mimeType: f.type, fileName: f.name, week: wk, group: user.group, userName: user.name };
                const res = await runAPI('upload', payload);
                showLoading(false);
                if(res && res.includes("http")) { 
                    alert("RPH berjaya dihantar!"); 
                    document.getElementById('fileInp').value = ""; // Clear file
                    fetchTeacherFiles(wk); // Refresh list
                } else { alert("Gagal memuat naik."); }
            };
            reader.readAsDataURL(f);
        }

        async function fetchTeacherFiles(weekName) {
            document.getElementById('teacherFilesArea').classList.remove('hidden');
            document.getElementById('lblTeacherWeek').innerText = weekName;
            const cont = document.getElementById('teacherFileList');
            cont.innerHTML = "<p class='text-xs text-gray-400 italic animate-pulse'>Menyemak fail anda...</p>";

            const res = await runAPI('getTeacherFiles', { group: user.group, week: weekName, userName: user.name });

            if(!res || res.status === "error") return cont.innerHTML = `<p class='text-xs text-red-500'>Tiada folder.</p>`;
            if(res.files.length === 0) return cont.innerHTML = `<p class='text-xs text-gray-500 italic'>Belum ada RPH dihantar untuk minggu ini.</p>`;

            cont.innerHTML = "";
            res.files.forEach(f => {
                let isSemakan = f.name.includes("[SEMAKAN]");
                let style = isSemakan ? "bg-green-50 border-green-200" : "bg-white border-gray-200";
                let badge = isSemakan ? `<span class="bg-green-500 text-white text-[9px] px-2 py-0.5 rounded ml-2">TELAH DISEMAK</span>` : `<span class="bg-yellow-400 text-yellow-900 text-[9px] px-2 py-0.5 rounded ml-2 shadow-sm">MENUNGGU SEMAKAN</span>`;
                
                // Buang bracket nama dari fail supaya nampak kemas
                let cleanName = f.name.replace(`[${user.name}] `, '');

                cont.innerHTML += `
                <div class="flex justify-between items-center p-3 rounded-xl border ${style} shadow-sm">
                    <div class="flex-1 overflow-hidden">
                        <p class="text-xs font-bold text-gray-700 truncate">${cleanName}</p>
                        <div class="mt-1">${badge}</div>
                    </div>
                    <button onclick="window.open('${f.url}', '_blank')" class="ml-2 bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-[10px] font-bold hover:bg-indigo-200"><span class="material-icons text-sm">visibility</span></button>
                </div>`;
            });
        }

        // --- ADMIN: PAPARAN FOLDER DASHBOARD ---

        async function fetchAdminDashboard(weekName) {
            document.getElementById('submissionArea').classList.remove('hidden');
            document.getElementById('viewingWeek').innerText = weekName;
            const cont = document.getElementById('adminTeacherGrid');
            cont.innerHTML = "<p class='text-xs text-center text-gray-500 animate-pulse col-span-2'>Menyusun fail guru...</p>";

            const res = await runAPI('getAdminSubmissionsData', { group: user.group, week: weekName });
            
            if(!res || res.status === "error") return cont.innerHTML = `<p class='text-red-500 text-xs col-span-2'>${res?res.message:'Ralat sistem'}</p>`;
            
            cont.innerHTML = "";
            if(res.data.length === 0) return cont.innerHTML = "<p class='text-xs text-gray-500 col-span-2'>Tiada cikgu berdaftar dalam kumpulan ini.</p>";

            res.data.forEach(teacher => {
                // Konfigurasi Warna Kad: KUNING = Ada Fail Baru, BIRU = Bersih/Selesai
                let isYellow = teacher.statusColor === "YELLOW";
                let bgColor = isYellow ? "bg-yellow-50 border-yellow-300" : "bg-blue-50 border-blue-200";
                let titleColor = isYellow ? "text-yellow-800" : "text-blue-900";
                let iconColor = isYellow ? "text-yellow-500" : "text-blue-400";
                let statusBadge = isYellow ? `<span class="bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded text-[9px] font-bold shadow-sm animate-bounce">ADA RPH BARU</span>` : (teacher.files.length > 0 ? `<span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[9px] font-bold">SELESAI</span>` : `<span class="text-gray-400 text-[10px] italic">Tiada Hantaran</span>`);

                let cardHtml = `
                <div class="${bgColor} border p-4 rounded-2xl flex flex-col shadow-sm">
                    <div class="flex items-center justify-between mb-3 border-b border-black border-opacity-5 pb-2">
                        <div class="flex items-center space-x-2">
                            <span class="material-icons ${iconColor} text-3xl">folder</span>
                            <h4 class="font-bold text-sm ${titleColor}">${teacher.teacherName}</h4>
                        </div>
                        <div>${statusBadge}</div>
                    </div>
                    <div class="space-y-2 flex-1">
                `;

                if(teacher.files.length === 0) {
                    cardHtml += `<div class="py-2 text-center text-gray-400"><span class="material-icons text-xl opacity-50">description</span></div>`;
                } else {
                    teacher.files.forEach(f => {
                        let isSemakan = f.name.includes("[SEMAKAN]");
                        let cleanName = f.name.replace(`[${teacher.teacherName}] `, '');
                        
                        if(isSemakan) {
                            cardHtml += `
                            <div class="flex justify-between items-center bg-white p-2 rounded-lg border border-green-200 shadow-sm">
                                <span class="text-[10px] text-green-700 font-bold truncate pr-2">‚úîÔ∏è ${cleanName}</span>
                                <button onclick="window.open('${f.url}')" class="text-[9px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold hover:bg-green-200">LIHAT</button>
                            </div>`;
                        } else {
                            cardHtml += `
                            <div class="flex flex-col space-y-2 bg-white p-2 rounded-lg border border-gray-200 shadow-sm">
                                <span class="text-xs text-gray-700 font-medium truncate">üìÑ ${cleanName}</span>
                                <div class="flex space-x-1">
                                    <button onclick="window.open('${f.url}')" class="flex-1 text-[10px] bg-gray-100 text-gray-600 py-1.5 rounded font-bold hover:bg-gray-200">Buka</button>
                                    <button onclick="openReview('${f.url}', '${f.id}', '${f.name}')" class="flex-1 text-[10px] bg-indigo-600 text-white py-1.5 rounded font-bold hover:bg-indigo-700 flex justify-center items-center"><span class="material-icons text-[11px] mr-1">edit</span>CONTENG</button>
                                </div>
                            </div>`;
                        }
                    });
                }

                cardHtml += `</div></div>`;
                cont.innerHTML += cardHtml;
            });
        }

        // --- FUNGSI CANVAS (CONTENG) ---
        function openReview(fileUrl, fileId, fileName) {
            currentFileId = fileId;
            document.getElementById('reviewFileName').innerText = fileName;
            
            const isImage = fileName.toLowerCase().match(/\.(jpeg|jpg|png|gif)$/i);
            const img = document.getElementById('reviewImage');
            
            if(isImage) { img.src = "https://drive.google.com/thumbnail?id=" + fileId + "&sz=w1000"; } 
            else {
                alert("Fail ini adalah PDF. Sila lihat di tab sebelah dan gunakan 'Kertas Kosong' di bawah untuk Cop Pengesahan.");
                window.open(fileUrl, '_blank');
                img.src = "https://via.placeholder.com/600x800/ffffff/cccccc?text=Ruang+Catatan+Penyemak";
            }

            document.getElementById('reviewModal').classList.remove('hidden');
            document.getElementById('reviewModal').classList.add('flex');
            img.onload = setupCanvas;
        }

        function closeReview() {
            document.getElementById('reviewModal').classList.add('hidden');
            document.getElementById('reviewModal').classList.remove('flex');
        }

        function setupCanvas() {
            canvas = document.getElementById('reviewCanvas');
            ctx = canvas.getContext('2d');
            const img = document.getElementById('reviewImage');
            
            canvas.width = img.width || 300;
            canvas.height = img.height || 400;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            canvas.onmousedown = startDraw; canvas.onmousemove = draw;
            canvas.onmouseup = endDraw; canvas.onmouseout = endDraw;
            canvas.ontouchstart = (e) => { e.preventDefault(); startDraw(e.touches[0]); };
            canvas.ontouchmove = (e) => { e.preventDefault(); draw(e.touches[0]); };
            canvas.ontouchend = endDraw;
        }

        function startDraw(e) { isDrawing = true; draw(e); }
        function endDraw() { isDrawing = false; ctx.beginPath(); }
        
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            ctx.lineWidth = 4; ctx.lineCap = 'round';
            ctx.strokeStyle = document.getElementById('penColor').value;
            ctx.lineTo(x, y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x, y);
        }

        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        async function saveSemakan() {
            if(!currentFileId) return;
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = canvas.width; finalCanvas.height = canvas.height;
            const fCtx = finalCanvas.getContext('2d');
            
            try {
                fCtx.drawImage(document.getElementById('reviewImage'), 0, 0, finalCanvas.width, finalCanvas.height);
                fCtx.drawImage(canvas, 0, 0);

                const dataURL = finalCanvas.toDataURL('image/png');
                const base64Data = dataURL.split(',')[1];
                
                showLoading(true, "MENYIMPAN SEMAKAN...");
                const res = await runAPI('saveAnnotation', { fileId: currentFileId, image: base64Data });
                showLoading(false);
                
                if(res && res.status === "success") {
                    alert("Semakan berjaya disimpan!");
                    closeReview();
                    fetchAdminDashboard(document.getElementById('viewingWeek').innerText); // Refresh panel admin
                } else alert("Gagal disimpan.");
            } catch (err) { showLoading(false); alert("Ralat menyimpan fail."); }
        }

        function accessMaster() { if(prompt("Kod Master:") === "101010") { document.getElementById('loginSection').style.display = 'none'; document.getElementById('masterPanel').classList.add('active-tab'); } }
    </script>
</body>
</html>
